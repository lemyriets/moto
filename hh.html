<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Модуль HeadHunter</title>
<!-- 2015-01-18 Вс. 01:01 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="rigidus" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<!-- -*- fill-column: 92 -*- -->
<!-- org-toggle-inline-images -->
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Модуль HeadHunter</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Цель</a></li>
<li><a href="#sec-2">2. Как это работает?</a>
<ul>
<li><a href="#sec-2-1">2.1. Источник вакансий</a></li>
<li><a href="#sec-2-2">2.2. Фабрика генераторов вакансий</a></li>
<li><a href="#sec-2-3">2.3. Определение правила обработки</a></li>
<li><a href="#sec-2-4">2.4. Процессор правил</a></li>
<li><a href="#sec-2-5">2.5. Декоратор для <code>process-teaser</code></a></li>
<li><a href="#sec-2-6">2.6. Получение и обработка вакансий правилами</a></li>
<li><a href="#sec-2-7">2.7. Составление правил</a>
<ul>
<li><a href="#sec-2-7-1">2.7.1. Правила отсева тизеров</a></li>
<li><a href="#sec-2-7-2">2.7.2. <span class="todo nilTODO">TODO</span> Правила анализа вакансий</a></li>
</ul>
</li>
<li><a href="#sec-2-8">2.8. Построение URL-ов, для скачивания тизеров</a>
<ul>
<li><a href="#sec-2-8-1">2.8.1. Построение специализаций</a></li>
</ul>
</li>
<li><a href="#sec-2-9">2.9. Получение страниц</a></li>
<li><a href="#sec-2-10">2.10. Разбор тизеров вакансий</a>
<ul>
<li><a href="#sec-2-10-1">2.10.1. Трансформация дерева</a></li>
<li><a href="#sec-2-10-2">2.10.2. <span class="todo nilWAIT">WAIT</span> Обход дерева и извлечение узлов</a></li>
</ul>
</li>
<li><a href="#sec-2-11">2.11. Разбор вакансий</a>
<ul>
<li><a href="#sec-2-11-1">2.11.1. <span class="todo nilWAIT">WAIT</span> Сопоставление и преобразование узлов</a></li>
</ul>
</li>
<li><a href="#sec-2-12">2.12. <span class="todo nilTODO">TODO</span> Незавершенное</a>
<ul>
<li><a href="#sec-2-12-1">2.12.1. Сохранение данных</a></li>
<li><a href="#sec-2-12-2">2.12.2. Состояния вакансии</a></li>
<li><a href="#sec-2-12-3">2.12.3. Еще кое-что</a></li>
<li><a href="#sec-2-12-4">2.12.4. Для красоты</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-3">3. Хотелки</a>
<ul>
<li><a href="#sec-3-1">3.1. Процесс найма с т.з. соискателя</a></li>
<li><a href="#sec-3-2">3.2. Процесс найма с т.з. HR-а</a></li>
<li><a href="#sec-3-3">3.3. Состояния вакансий</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Сценарии использования</a>
<ul>
<li><a href="#sec-4-1">4.1. Пользовательские</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1. Авторизация/регистрация</a></li>
<li><a href="#sec-4-1-2">4.1.2. Формализация предпочтений</a></li>
<li><a href="#sec-4-1-3">4.1.3. Отбор и сортировка вакансий</a></li>
<li><a href="#sec-4-1-4">4.1.4. Внесение заметок к вакансиям</a></li>
<li><a href="#sec-4-1-5">4.1.5. Заполнение резюме</a></li>
<li><a href="#sec-4-1-6">4.1.6. Написание сопроводительных писем</a></li>
<li><a href="#sec-4-1-7">4.1.7. Отправка отзывов</a></li>
</ul>
</li>
<li><a href="#sec-4-2">4.2. Поисковые профили</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. Список поисковых профилей</a></li>
<li><a href="#sec-4-2-2">4.2.2. Страничка поискового профиля</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. Поиск вакансий</a></li>
<li><a href="#sec-4-4">4.4. Ручной отбор вакансий</a></li>
<li><a href="#sec-4-5">4.5. Автоматический отбор вакансий</a></li>
<li><a href="#sec-4-6">4.6. Внесение заметок по вакансии</a></li>
<li><a href="#sec-4-7">4.7. Просмотр и отбор вакансий, заметки и выставление статусов</a></li>
<li><a href="#sec-4-8">4.8. Дашборд</a></li>
<li><a href="#sec-4-9">4.9. Отзывы соискателей о компаниях и вакансиях</a></li>
<li><a href="#sec-4-10">4.10. Размещение резюме</a></li>
<li><a href="#sec-4-11">4.11. Маршрут</a></li>
<li><a href="#sec-4-12">4.12. Создание вакансии работодателем</a></li>
<li><a href="#sec-4-13">4.13. Вакансия становится неактуальной</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Сущности</a>
<ul>
<li><a href="#sec-5-1">5.1. Поисковые профили</a></li>
<li><a href="#sec-5-2">5.2. Вакансии</a></li>
<li><a href="#sec-5-3">5.3. Перекрестные связи с другими вакансиями</a></li>
<li><a href="#sec-5-4">5.4. Компании</a></li>
<li><a href="#sec-5-5">5.5. Действия по вакансии: звонки, скайп-интервью, собеседования</a></li>
<li><a href="#sec-5-6">5.6. Теги вакансий</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Interface</a>
<ul>
<li><a href="#sec-6-1">6.1. Главная страница модуля</a></li>
<li><a href="#sec-6-2">6.2. Галлерея (parenscript)</a></li>
<li><a href="#sec-6-3">6.3. Список вакансий</a></li>
<li><a href="#sec-6-4">6.4. Дашборд</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Тесты</a></li>
<li><a href="#sec-8">8. Точки входа</a></li>
<li><a href="#sec-9">9. Сборка</a>
<ul>
<li><a href="#sec-9-1">9.1. Фунциональные утилиты</a>
<ul>
<li><a href="#sec-9-1-1">9.1.1. Point-free определения:</a></li>
<li><a href="#sec-9-1-2">9.1.2. Flip, карринг, композиции:</a></li>
<li><a href="#sec-9-1-3">9.1.3. Свёртки и "развёртки":</a></li>
<li><a href="#sec-9-1-4">9.1.4. Отображения и фильтрации:</a></li>
<li><a href="#sec-9-1-5">9.1.5. Функции для списков на основе карринга и свёрток:</a></li>
<li><a href="#sec-9-1-6">9.1.6. Функции для чисел:</a></li>
<li><a href="#sec-9-1-7">9.1.7. И для булевых чисел:</a></li>
<li><a href="#sec-9-1-8">9.1.8. Многие другие функции представляются свёртками, например:</a></li>
<li><a href="#sec-9-1-9">9.1.9. Свёртки для деревьев:</a></li>
</ul>
</li>
<li><a href="#sec-9-2">9.2. Другие утилиты</a></li>
<li><a href="#sec-9-3">9.3. Утилиты</a></li>
<li><a href="#sec-9-4">9.4. Глобальные определения</a></li>
<li><a href="#sec-9-5">9.5. Сущности и автоматы</a></li>
<li><a href="#sec-9-6">9.6. Поисковые профили</a></li>
<li><a href="#sec-9-7">9.7. Вакансии</a></li>
</ul>
</li>
</ul>
</div>
</div>
<link rel="stylesheet" type="text/css" href="css/css.css" />

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Цель</h2>
<div class="outline-text-2" id="text-1">
<p>
Мы все ищем работу на профильных сайтах время от времени. Иногда на это уходит
значительное время, т.к. мы выполняем множество рутинных действий, которых могли бы
избежать. Попробуем автоматизировать этот процесс.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Как это работает?</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Источник вакансий</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Пусть у нас есть источник вакансий, например, hh.ru. На нем можно сформулировать запрос и
получить выборку в виде списка тизеров вакансий, каждый из которых ведет на полное
описание вакансии.
</p>


<div id="fig:vacancy_source" class="figure">
<p><img src="./img/warehouse.jpg" alt="warehouse.jpg" />
</p>
<p><span class="figure-number">Figure 1:</span> Это источник вакансий</p>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Фабрика генераторов вакансий</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Пусть у нас есть фабрика <code>генераторов функций</code> назовем его <code>factory</code>, которая принимает
<code>источник вакансий</code> и параметры запроса (например: <code>профессиональную область</code>, <code>специализацию</code>,
<code>город</code>) и возвращает <code>функцию-генератор в замыкании</code>.
</p>


<div id="fig:factory" class="figure">
<p><img src="./img/factory.jpg" alt="factory.jpg" />
</p>
<p><span class="figure-number">Figure 2:</span> Фабрика генераторов вакансий</p>
</div>

<p>
Эта функция-генератор при каждом своем вызове вернет одну вакансию или <code>ложь</code> если все
вакансии кончились.
</p>


<div id="fig:generator" class="figure">
<p><img src="./img/generator.jpg" alt="generator.jpg" />
</p>
<p><span class="figure-number">Figure 3:</span> Функция-генератор, произведенная фабрикой</p>
</div>

<p>
Внутри себя эта функция по мере необходимости загружает и разбирает сначала тизеры
вакансий, а потом и сами вакансии, при этом процесс превращения тизера в вакансию
(<code>process-teaser</code>) вынесен из замыкания, т.к. не зависит от замкнутых переменных.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="factory">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;make_hh_url&gt;&gt;

&lt;&lt;hh_get_page&gt;&gt;

&lt;&lt;hh_parse_vacancy_teasers&gt;&gt;

&lt;&lt;hh_parse_vacancy&gt;&gt;

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> (current-teaser)
  (hh-parse-vacancy (hh-get-page (getf current-teaser <span style="color: #483d8b;">:id</span>))))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">factory</span> ((vac-src (eql 'hh)) city prof-area <span style="color: #228b22;">&amp;optional</span> spec)
  (<span style="color: #a020f0;">let</span> ((url     (make-hh-url city prof-area spec))
        (page    0)
        (teasers nil))
    (alexandria:named-lambda get-vacancy ()
      (<span style="color: #a020f0;">labels</span> ((load-next-teasers-page ()
                 (dbg <span style="color: #8b2252;">"~~ LOAD (page=~A)"</span> page)
                 (setf teasers (hh-parse-vacancy-teasers (hh-get-page (format nil url page))))
                 (incf page)
                 (<span style="color: #a020f0;">when</span> (equal 0 (length teasers))
                   (dbg <span style="color: #8b2252;">"~~ FIN"</span>)
                   (<span style="color: #a020f0;">return-from</span> get-vacancy 'nil)))
               (get-teaser ()
                 (<span style="color: #a020f0;">when</span> (equal 0 (length teasers))
                   (load-next-teasers-page))
                 (<span style="color: #a020f0;">let</span> ((current-teaser (car teasers)))
                   (setf teasers (cdr teasers))
                   current-teaser)))
        (<span style="color: #a020f0;">tagbody</span> get-new-teaser
           (<span style="color: #a020f0;">let</span> ((current-teaser (get-teaser)))
             (<span style="color: #a020f0;">let</span> ((current-vacancy (process-teaser current-teaser)))
               (<span style="color: #a020f0;">if</span> (null current-vacancy)
                   (<span style="color: #a020f0;">go</span> get-new-teaser)
                   (<span style="color: #a020f0;">return-from</span> get-vacancy (merge-plists current-teaser current-vacancy))))))))))
</pre>
</div>

<p>
Для работы этому генератору нужно уметь:
</p>
<ul class="org-ul">
<li>Собирать URL страницы, где лежат тизеры (краткие описания) вакансий из параметов запроса
(<code>make-hh-url</code>)
</li>
<li>Скачивать HTML-страницы (<code>hh-get-page</code>)
</li>
<li>Разбирать тизеры из html-кода (<code>hh-parse-vacancy-teasers</code>)
</li>
<li>Обрабатывать разобранные тизеры (<code>hh-parse-vacancy</code>), чтобы получить по ним вакансии.
</li>
</ul>
<p>
Но я не буду сейчас на этом останавливаться и опишу потом, в соответствующих разделах.
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Определение правила обработки</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Пусть у нас есть возможность создавать именованные <code>правила</code>, которые получают на вход
список, представляющий собой тизер или вакансию, анализируют его, и выполняют какие-то
действия. В качестве примера, мы могли бы создать правило, которое добавляет к вакансии
поле <code>interested</code> если зарплата и язык разработки нас устраивает.
</p>

<p>
Правило принимает на вход условие срабатывания и код, который будет выполнен, в случае
если условие выполняется на обрабатываемой вакансии.
</p>

<p>
Примем соглашение, что правило возвращает два значения:
</p>
<ul class="org-ul">
<li>первое - вакансию (возможно измененную)
</li>
<li>второе - указание процессору правил (например, прекратить обработку)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="define_rule">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define-rule</span> (antecedent <span style="color: #228b22;">&amp;body</span> consequent)
  `(alexandria:named-lambda ,(gensym <span style="color: #8b2252;">"RULE-"</span>) (vacancy)
     (<span style="color: #a020f0;">if</span> ,antecedent
         (<span style="color: #a020f0;">let</span> ((result (<span style="color: #a020f0;">progn</span> ,@consequent)))
           (values vacancy result))
         vacancy)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '(define-rule (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                                   </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name))))</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(setf (getf vacancy :interested) t)</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">:stop))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (ALEXANDRIA.0.DEV:NAMED-LAMBDA #:RULE-3676 (VACANCY)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(IF (AND (&gt; (GETF VACANCY :SALARY) 70000)</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">(NOT (CONTAINS "Java" (GETF VACANCY :NAME))))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(LET ((RESULT (PROGN (SETF (GETF VACANCY :INTERESTED) T) :STOP)))</span>
<span style="color: #b22222;">;;            </span><span style="color: #b22222;">(VALUES VACANCY RESULT))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">VACANCY)), T</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(multiple-value-bind (vacancy rule-result)</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(funcall</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(define-rule (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                        </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name))))</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(setf (getf vacancy :interested) t)</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">:stop)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">'(:name "Python" :salary 80000))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(dbg "vacancy: ~A ~% rule-result: ~A" (bprint vacancy) (bprint rule-result)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">-&gt;  vacancy: (:INTERESTED T :NAME "Python" :SALARY 80000)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">-&gt;  rule-result: :STOP</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> Процессор правил</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Теперь мы можем создать процессор правил <code>process</code>, который применяет к вакансии правила
поочередно. По сути, это <code>машина Э.Поста</code>, а все вместе представляет собой <code>продукционную
  систему</code> с прямой цепочкой вывода. Подробнее про продукционные системы <a href="http://www.ngpedia.ru/id429603p1.html">тут</a> и <a href="http://www.myshared.ru/slide/445840/">тут</a>.
</p>


<div id="fig:production_system" class="figure">
<p><img src="./img/production_system.gif" alt="production_system.gif" />
</p>
<p><span class="figure-number">Figure 4:</span> Продукционная система</p>
</div>

<p>
Процессор правил обрабатывает следущие особые случаи:
</p>
<ul class="org-ul">
<li>Если какое-то из правил возвращает во втором параметре <code>:stop</code> - обработка прекращается
и возвращается текущий обработанный результат
</li>
<li>Если какое-то из правил возвращает во втором параметре <code>:renew</code> - то обработка текущего
входного результата начинается с самого первого правила.
</li>
</ul>
<p>
По окончании обработки возвращается результирующая вакансия, которая может быть
модифицирована правилами
</p>


<div class="figure">
<p><img src="./img/process.png" alt="process.png" />
</p>
</div>
<div class="org-src-container">

<pre class="src src-lisp" id="process">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">process</span> (vacancy rules)
  (<span style="color: #a020f0;">tagbody</span>
   renew
     (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> rule <span style="color: #483d8b;">:in</span> rules <span style="color: #483d8b;">:do</span>
        (<span style="color: #a020f0;">multiple-value-bind</span> (vacancy-result rule-result)
            (funcall rule vacancy)
          (setf vacancy vacancy-result)
          (<span style="color: #a020f0;">when</span> (equal rule-result <span style="color: #483d8b;">:stop</span>)
            (<span style="color: #a020f0;">return-from</span> process vacancy))
          (<span style="color: #a020f0;">when</span> (equal rule-result <span style="color: #483d8b;">:renew</span>)
            (<span style="color: #a020f0;">go</span> renew)))))
  vacancy)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(let ((tmp 0))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(process '(:name "Python" :salary 80000)</span>
<span style="color: #b22222;">;;            </span><span style="color: #b22222;">(list</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(define-rule (equal 12 tmp)</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">(setf (getf vacancy :tmp) tmp)</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">:stop)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(define-rule (and (&gt; (getf vacancy :salary) 70000)</span>
<span style="color: #b22222;">;;                               </span><span style="color: #b22222;">(not (contains "Java" (getf vacancy :name))))</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">(print (incf tmp))</span>
<span style="color: #b22222;">;;               </span><span style="color: #b22222;">:renew)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> Декоратор для <code>process-teaser</code></h3>
<div class="outline-text-3" id="text-2-5">
<p>
Поскольку и вакансии и их тизеры представлены у нас одинаково, мы можем применять правила
и к тем и к другим. Это позволит отфильтровать некоторые вакансии только анализируя их
тизеры и не загружать лишнего.
</p>

<p>
Для того, чтобы сделать это удобным образом, обернем (:around method) <code>process-teaser</code>
так, чтобы исключить из дальнейшей обрабоки те тизеры, которые нам не нравятся. Например
те, у которых нет указания зарплаты или она слишком низка. После того, как тизер
превратиться в вакансию мы применим к ней другой список правил, которые реализуют все
остальную логику.
</p>



<div class="figure">
<p><img src="./img/around.png" alt="around.png" />
</p>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="process_teaser_around">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;rules&gt;&gt;

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">process-teaser</span> <span style="color: #483d8b;">:around</span> (current-teaser)
  (aif (process current-teaser *rules-for-teaser*)
       (process (call-next-method it) *rules-for-vacancy*)
       nil))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> Получение и обработка вакансий правилами</h3>
<div class="outline-text-3" id="text-2-6">
<p>
Теперь мы можем получить генератор, и, вызывая его, забирать вакансии, пока они не
закончатся. Все вакансии будут корректно обработаны правилами - сначала на этапе получения
тизеров, а потом на этапе получения вакансий.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="run">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;define_rule&gt;&gt;

&lt;&lt;process&gt;&gt;

&lt;&lt;process_teaser_around&gt;&gt;

&lt;&lt;factory&gt;&gt;

(<span style="color: #a020f0;">let</span> ((gen (factory 'hh <span style="color: #8b2252;">"spb"</span> <span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
                    <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)))
  (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> i <span style="color: #483d8b;">:from</span> 1 <span style="color: #483d8b;">:to</span> 100 <span style="color: #483d8b;">:do</span>
     (dbg <span style="color: #8b2252;">"~A"</span> i)
     (<span style="color: #a020f0;">let</span> ((vacancy (funcall gen)))
       (<span style="color: #a020f0;">when</span> (null vacancy)
         (<span style="color: #a020f0;">return</span>))
       (dbg <span style="color: #8b2252;">"~A"</span> (bprint vacancy)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7"><span class="section-number-3">2.7</span> Составление правил</h3>
<div class="outline-text-3" id="text-2-7">
<p>
Чтобы записать правила их более компактно, подсластим синтаксис, используя макросы
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">drop-by-name</span> (text)
   `(<span style="color: #a020f0;">define-rule</span> (contains (getf vacancy <span style="color: #483d8b;">:name</span>) ,text)
      (dbg <span style="color: #8b2252;">"drop: name contains ~A"</span> ,text)
      (setf vacancy nil)
      <span style="color: #483d8b;">:stop</span>))

 <span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

 <span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '(drop-by-name "IOS"))</span>

 <span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (DEFINE-RULE (CONTAINS (GETF VACANCY :NAME) "IOS")</span>
 <span style="color: #b22222;">;;      </span><span style="color: #b22222;">(DBG "drop: name contains ~A" "IOS")</span>
 <span style="color: #b22222;">;;      </span><span style="color: #b22222;">(SETF VACANCY NIL)</span>
 <span style="color: #b22222;">;;      </span><span style="color: #b22222;">:STOP), T</span>

 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">drop-names</span> (<span style="color: #228b22;">&amp;rest</span> names)
   `(list ,@(<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> name <span style="color: #483d8b;">:in</span> names <span style="color: #483d8b;">:collect</span>
               `(drop-by-name ,name))))

 <span style="color: #b22222;">;; </span><span style="color: #b22222;">expand</span>

 (macroexpand-1 '(drop-names <span style="color: #8b2252;">"IOS"</span> <span style="color: #8b2252;">"1&#1057;"</span> <span style="color: #8b2252;">"C++"</span>))

 <span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (LIST (DROP-BY-NAME "IOS") (DROP-BY-NAME "1&#1057;") (DROP-BY-NAME "C++")), T</span>


&lt;&lt;rules_for_vacancy&gt;&gt;

&lt;&lt;rules_for_teasers&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-2-7-1" class="outline-4">
<h4 id="sec-2-7-1"><span class="section-number-4">2.7.1</span> Правила отсева тизеров</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
Какие же правила и действия можно составить для того чтобы отсеять неинтересные тизеры
вакансий? В основном те, которые не устраивают по зарплате и те, у которых в названиях
упомянуты неинтересные технологии. К примеру, я не хочу даже смотреть на вакансии у
которых не указана зарплата или она ниже минимально премлимой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_teasers">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*rules-for-teaser*</span>
  (append
   (list
    (<span style="color: #a020f0;">define-rule</span> (null (getf vacancy <span style="color: #483d8b;">:salary</span>))
      (dbg <span style="color: #8b2252;">"drop: &#1053;&#1077;&#1090; &#1079;&#1072;&#1088;&#1087;&#1083;&#1072;&#1090;&#1099;"</span>)
      (setf vacancy nil)
      <span style="color: #483d8b;">:stop</span>)
    (<span style="color: #a020f0;">define-rule</span> (&lt; (parse-integer (getf vacancy <span style="color: #483d8b;">:salary</span>)) 90000)
      (dbg <span style="color: #8b2252;">"drop: &#1052;&#1072;&#1083;&#1077;&#1085;&#1100;&#1082;&#1072;&#1103; &#1079;&#1072;&#1088;&#1087;&#1083;&#1072;&#1090;&#1072;"</span>)
      (setf vacancy nil)
      <span style="color: #483d8b;">:stop</span>))
   (drop-names <span style="color: #8b2252;">"IOS"</span> <span style="color: #8b2252;">"1&#1057;"</span> <span style="color: #8b2252;">"C++"</span> <span style="color: #8b2252;">"Ruby on Rails"</span> <span style="color: #8b2252;">"Frontend"</span> <span style="color: #8b2252;">"Go"</span> <span style="color: #8b2252;">"Qa"</span> <span style="color: #8b2252;">"C#"</span> <span style="color: #8b2252;">".NET"</span> <span style="color: #8b2252;">"Unity3D"</span> <span style="color: #8b2252;">"Flash"</span> <span style="color: #8b2252;">"Java"</span> <span style="color: #8b2252;">"Android"</span> <span style="color: #8b2252;">"ASP"</span> <span style="color: #8b2252;">"Objective-C"</span> <span style="color: #8b2252;">"Front End"</span> <span style="color: #8b2252;">"Go"</span>)
   ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-7-2" class="outline-4">
<h4 id="sec-2-7-2"><span class="section-number-4">2.7.2</span> <span class="todo TODO">TODO</span> Правила анализа вакансий</h4>
<div class="outline-text-4" id="text-2-7-2">
<ul class="org-ul">
<li>Если это уже существующая в базе вакансия и ничего не изменилось - игнорируем и
останавливаем ее обработку
</li>
<li>Заносим вакансию в базу.
</li>
<li>Я не хочу смотреть на вакансии, в компаниях где я уже работал.
</li>
<li>Я хочу присвоить вакансии определенный ранг, в зависимости от з\п
</li>
<li>Я хочу увеличивать этот ранг за упоминание в тексте описания вакансии моих любимых
слов: Lisp, Erlang, Prolog, Haskell
</li>
<li>Я хочу особо отметить вакансии, у которых ранг выше [порогового ранга], чтобы [отправить отклик]
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="rules_for_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*rules-for-vacancy*</span>
  (list
   <span style="color: #b22222;">;; </span><span style="color: #b22222;">(define-rule nil</span>
   <span style="color: #b22222;">;;   </span><span style="color: #b22222;">(dbg "empty")</span>
   <span style="color: #b22222;">;;   </span><span style="color: #b22222;">;; (setf vacancy nil)</span>
   <span style="color: #b22222;">;;   </span><span style="color: #b22222;">:stop)</span>
   ))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2-8" class="outline-3">
<h3 id="sec-2-8"><span class="section-number-3">2.8</span> Построение URL-ов, для скачивания тизеров</h3>
<div class="outline-text-3" id="text-2-8">
<p>
Тизеры вакансий размещаются постранично, по 20 штук на странице, и мы можем собрать все
страницы, если будем получать страницу за страницей, пока не получим страницу, на которой
вакансий нет.
</p>

<p>
В качестве GET-параметров запросы указываются <code>специализации</code> и город. Значения <code>cluster</code>
и <code>area</code> не меняются. Поэтому, единственная сложность построения URL - это правильно
сформировать <code>специализации</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_hh_url">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;make_specialization_hh_url_string&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-hh-url</span> (city prof-area <span style="color: #228b22;">&amp;optional</span> specs)
  (format nil <span style="color: #8b2252;">"http://~A.hh.ru/search/vacancy?clusters=true&amp;specialization=~A&amp;area=~A&amp;page=~~A"</span>
          city
          (make-specialization-hh-url-string prof-area specs)
          2))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

(make-hh-url <span style="color: #8b2252;">"spb"</span> <span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>)
</pre>
</div>
</div>

<div id="outline-container-sec-2-8-1" class="outline-4">
<h4 id="sec-2-8-1"><span class="section-number-4">2.8.1</span> Построение специализаций</h4>
<div class="outline-text-4" id="text-2-8-1">
<p>
Специализации задаются в формате "1.221", где цифра слева от точки представляет
профессиональное направление, а справа - собственно специализацию. В интерфейсе
допустимо выбрать одно направление и несколько специализаций в нем, при этом для каждой
специализации формируется параметр GET-запроса. Допустимо выбрать только направление,
без специализаций.
</p>

<p>
По этой причине мы должны иметь дерево специализаций и транслятор названий специализаций
в их номера.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="make_specialization_hh_url_string">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;prof_areas&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-specialization-hh-url-string</span> (prof-area <span style="color: #228b22;">&amp;optional</span> specs)
  (<span style="color: #a020f0;">let</span> ((specialization (assoc prof-area *prof-areas* <span style="color: #483d8b;">:test</span> #'equal)))
    (<span style="color: #a020f0;">when</span> (null specialization)
      (err 'specialization-not-found))
    (<span style="color: #a020f0;">when</span> (stringp specs)
      (setf specs (list specs)))
    (<span style="color: #a020f0;">if</span> (null specs)
        (concatenate 'string
                     <span style="color: #8b2252;">"&amp;specialization="</span>
                     (cadr specialization))
        (format nil <span style="color: #8b2252;">"~{&amp;~A~}"</span>
                (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> spec <span style="color: #483d8b;">:in</span> specs <span style="color: #483d8b;">:collect</span>
                   (<span style="color: #a020f0;">let</span> ((spec (cdr (assoc spec (caddr specialization) <span style="color: #483d8b;">:test</span> #'equal))))
                     (<span style="color: #a020f0;">when</span> (null spec)
                       (err 'spec-not-found))
                     (concatenate 'string <span style="color: #8b2252;">"specialization="</span> (cadr specialization) <span style="color: #8b2252;">"."</span> spec)))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">test</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" '("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;" "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;")</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(make-specialization-hh-url-string "&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
<span style="color: #b22222;">;;                                    </span><span style="color: #b22222;">'("&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span>
<span style="color: #b22222;">;;                                      </span><span style="color: #b22222;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"))</span>
</pre>
</div>

<p>
Дерево специализаций будем хранить в глобальном alist-е, т.к. оно никогда не меняется. Я
не стал заполнять его целиком, ограничившись только профессиональной областью "ИТ". По
необходимости заполню остальное.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="prof_areas">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*prof-areas*</span>
  '((<span style="color: #8b2252;">"&#1042;&#1089;&#1077; &#1087;&#1088;&#1086;&#1092;&#1077;&#1089;&#1089;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080;"</span> . (<span style="color: #8b2252;">""</span>))
    (<span style="color: #8b2252;">"&#1048;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1086;&#1085;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;, &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;, &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;"</span>
     . (<span style="color: #8b2252;">"1"</span> ((<span style="color: #8b2252;">"CRM &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099;"</span> . <span style="color: #8b2252;">"536"</span>)
             (<span style="color: #8b2252;">"CTO, CIO, &#1044;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088; &#1087;&#1086; IT"</span> . <span style="color: #8b2252;">"3"</span>)
             (<span style="color: #8b2252;">"Web &#1080;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"9"</span>)
             (<span style="color: #8b2252;">"Web &#1084;&#1072;&#1089;&#1090;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"10"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088; &#1073;&#1072;&#1079; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;"</span> . <span style="color: #8b2252;">"420"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1085;&#1072;&#1083;&#1080;&#1090;&#1080;&#1082;"</span> . <span style="color: #8b2252;">"25"</span>)
             (<span style="color: #8b2252;">"&#1040;&#1088;&#1090;-&#1076;&#1080;&#1088;&#1077;&#1082;&#1090;&#1086;&#1088;"</span> . <span style="color: #8b2252;">"30"</span>)
             (<span style="color: #8b2252;">"&#1041;&#1072;&#1085;&#1082;&#1086;&#1074;&#1089;&#1082;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #8b2252;">"395"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1075;&#1088;&#1086;&#1074;&#1086;&#1077; &#1055;&#1054;"</span> . <span style="color: #8b2252;">"475"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1085;&#1078;&#1077;&#1085;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"82"</span>)
             (<span style="color: #8b2252;">"&#1048;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #8b2252;">"89"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1084;&#1087;&#1100;&#1102;&#1090;&#1077;&#1088;&#1085;&#1072;&#1103; &#1073;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . <span style="color: #8b2252;">"110"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1089;&#1072;&#1083;&#1090;&#1080;&#1085;&#1075;, &#1040;&#1091;&#1090;&#1089;&#1086;&#1088;&#1089;&#1080;&#1085;&#1075;"</span> . <span style="color: #8b2252;">"113"</span>)
             (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1090;&#1077;&#1085;&#1090;"</span> . <span style="color: #8b2252;">"116"</span>)
             (<span style="color: #8b2252;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;"</span> . <span style="color: #8b2252;">"137"</span>)
             (<span style="color: #8b2252;">"&#1052;&#1091;&#1083;&#1100;&#1090;&#1080;&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . <span style="color: #8b2252;">"161"</span>)
             (<span style="color: #8b2252;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1091;&#1088;&#1086;&#1074;&#1077;&#1085;&#1100;, &#1052;&#1072;&#1083;&#1086; &#1086;&#1087;&#1099;&#1090;&#1072;"</span> . <span style="color: #8b2252;">"172"</span>)
             (<span style="color: #8b2252;">"&#1054;&#1087;&#1090;&#1080;&#1084;&#1080;&#1079;&#1072;&#1094;&#1080;&#1103; &#1089;&#1072;&#1081;&#1090;&#1072; (SEO)"</span> . <span style="color: #8b2252;">"400"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1077;&#1088;&#1077;&#1076;&#1072;&#1095;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1080; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1074; &#1080;&#1085;&#1090;&#1077;&#1088;&#1085;&#1077;&#1090;"</span> . <span style="color: #8b2252;">"203"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1086;&#1076;&#1076;&#1077;&#1088;&#1078;&#1082;&#1072;, Helpdesk"</span> . <span style="color: #8b2252;">"211"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;, &#1056;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span> . <span style="color: #8b2252;">"221"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . <span style="color: #8b2252;">"225"</span>)
             (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1102;&#1089;&#1077;&#1088;"</span> . <span style="color: #8b2252;">"232"</span>)
             (<span style="color: #8b2252;">"&#1056;&#1072;&#1079;&#1074;&#1080;&#1090;&#1080;&#1077; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;&#1072;"</span> . <span style="color: #8b2252;">"246"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1077;&#1090;&#1077;&#1074;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"270"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1072;&#1103; &#1080;&#1085;&#1090;&#1077;&#1075;&#1088;&#1072;&#1094;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"272"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;"</span> . <span style="color: #8b2252;">"273"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1072;&#1074;&#1090;&#1086;&#1084;&#1072;&#1090;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"274"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1080;&#1089;&#1090;&#1077;&#1084;&#1099; &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1077;&#1084; (ERP)"</span> . <span style="color: #8b2252;">"50"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1086;&#1090;&#1086;&#1074;&#1099;&#1077;, &#1041;&#1077;&#1089;&#1087;&#1088;&#1086;&#1074;&#1086;&#1076;&#1085;&#1099;&#1077; &#1090;&#1077;&#1093;&#1085;&#1086;&#1083;&#1086;&#1075;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"277"</span>)
             (<span style="color: #8b2252;">"&#1057;&#1090;&#1072;&#1088;&#1090;&#1072;&#1087;&#1099;"</span> . <span style="color: #8b2252;">"474"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&#1084;&#1091;&#1085;&#1080;&#1082;&#1072;&#1094;&#1080;&#1080;"</span> . <span style="color: #8b2252;">"295"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . <span style="color: #8b2252;">"117"</span>)
             (<span style="color: #8b2252;">"&#1058;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1087;&#1080;&#1089;&#1072;&#1090;&#1077;&#1083;&#1100;"</span> . <span style="color: #8b2252;">"296"</span>)
             (<span style="color: #8b2252;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1088;&#1086;&#1077;&#1082;&#1090;&#1072;&#1084;&#1080;"</span> . <span style="color: #8b2252;">"327"</span>)
             (<span style="color: #8b2252;">"&#1069;&#1083;&#1077;&#1082;&#1090;&#1088;&#1086;&#1085;&#1085;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1094;&#1080;&#1103;"</span> . <span style="color: #8b2252;">"359"</span>))))
    (<span style="color: #8b2252;">"&#1041;&#1091;&#1093;&#1075;&#1072;&#1083;&#1090;&#1077;&#1088;&#1080;&#1103;, &#1091;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1091;&#1095;&#1077;&#1090;, &#1092;&#1080;&#1085;&#1072;&#1085;&#1089;&#1099; &#1087;&#1088;&#1077;&#1076;&#1087;&#1088;&#1080;&#1103;&#1090;&#1080;&#1103;"</span> . (<span style="color: #8b2252;">"2"</span>))
    (<span style="color: #8b2252;">"&#1052;&#1072;&#1088;&#1082;&#1077;&#1090;&#1080;&#1085;&#1075;, &#1088;&#1077;&#1082;&#1083;&#1072;&#1084;&#1072;, PR"</span> . (<span style="color: #8b2252;">"3"</span>))
    (<span style="color: #8b2252;">"&#1040;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1080;&#1074;&#1085;&#1099;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"4"</span>))
    (<span style="color: #8b2252;">"&#1041;&#1072;&#1085;&#1082;&#1080;, &#1080;&#1085;&#1074;&#1077;&#1089;&#1090;&#1080;&#1094;&#1080;&#1080;, &#1083;&#1080;&#1079;&#1080;&#1085;&#1075;"</span> . (<span style="color: #8b2252;">"5"</span>))
    (<span style="color: #8b2252;">"&#1059;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1077; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;&#1086;&#1084;, &#1090;&#1088;&#1077;&#1085;&#1080;&#1085;&#1075;&#1080;"</span> . (<span style="color: #8b2252;">"6"</span>))
    (<span style="color: #8b2252;">"&#1040;&#1074;&#1090;&#1086;&#1084;&#1086;&#1073;&#1080;&#1083;&#1100;&#1085;&#1099;&#1081; &#1073;&#1080;&#1079;&#1085;&#1077;&#1089;"</span> . (<span style="color: #8b2252;">"7"</span>))
    (<span style="color: #8b2252;">"&#1041;&#1077;&#1079;&#1086;&#1087;&#1072;&#1089;&#1085;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #8b2252;">"8"</span>))
    (<span style="color: #8b2252;">"&#1042;&#1099;&#1089;&#1096;&#1080;&#1081; &#1084;&#1077;&#1085;&#1077;&#1076;&#1078;&#1084;&#1077;&#1085;&#1090;"</span> . (<span style="color: #8b2252;">"9"</span>))
    (<span style="color: #8b2252;">"&#1044;&#1086;&#1073;&#1099;&#1095;&#1072; &#1089;&#1099;&#1088;&#1100;&#1103;"</span> . (<span style="color: #8b2252;">"10"</span>))
    (<span style="color: #8b2252;">"&#1048;&#1089;&#1082;&#1091;&#1089;&#1089;&#1090;&#1074;&#1086;, &#1088;&#1072;&#1079;&#1074;&#1083;&#1077;&#1095;&#1077;&#1085;&#1080;&#1103;, &#1084;&#1072;&#1089;&#1089;-&#1084;&#1077;&#1076;&#1080;&#1072;"</span> . (<span style="color: #8b2252;">"11"</span>))
    (<span style="color: #8b2252;">"&#1050;&#1086;&#1085;&#1089;&#1091;&#1083;&#1100;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"12"</span>))
    (<span style="color: #8b2252;">"&#1052;&#1077;&#1076;&#1080;&#1094;&#1080;&#1085;&#1072;, &#1092;&#1072;&#1088;&#1084;&#1072;&#1094;&#1077;&#1074;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #8b2252;">"13"</span>))
    (<span style="color: #8b2252;">"&#1053;&#1072;&#1091;&#1082;&#1072;, &#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"14"</span>))
    (<span style="color: #8b2252;">"&#1043;&#1086;&#1089;&#1091;&#1076;&#1072;&#1088;&#1089;&#1090;&#1074;&#1077;&#1085;&#1085;&#1072;&#1103; &#1089;&#1083;&#1091;&#1078;&#1073;&#1072;, &#1085;&#1077;&#1082;&#1086;&#1084;&#1084;&#1077;&#1088;&#1095;&#1077;&#1089;&#1082;&#1080;&#1077; &#1086;&#1088;&#1075;&#1072;&#1085;&#1080;&#1079;&#1072;&#1094;&#1080;&#1080;"</span> . (<span style="color: #8b2252;">"16"</span>))
    (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1076;&#1072;&#1078;&#1080;"</span> . (<span style="color: #8b2252;">"17"</span>))
    (<span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1080;&#1079;&#1074;&#1086;&#1076;&#1089;&#1090;&#1074;&#1086;"</span> . (<span style="color: #8b2252;">"18"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1090;&#1088;&#1072;&#1093;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> . (<span style="color: #8b2252;">"19"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1090;&#1088;&#1086;&#1080;&#1090;&#1077;&#1083;&#1100;&#1089;&#1090;&#1074;&#1086;, &#1085;&#1077;&#1076;&#1074;&#1080;&#1078;&#1080;&#1084;&#1086;&#1089;&#1090;&#1100;"</span> . (<span style="color: #8b2252;">"20"</span>))
    (<span style="color: #8b2252;">"&#1058;&#1088;&#1072;&#1085;&#1089;&#1087;&#1086;&#1088;&#1090;, &#1083;&#1086;&#1075;&#1080;&#1089;&#1090;&#1080;&#1082;&#1072;"</span> . (<span style="color: #8b2252;">"21"</span>))
    (<span style="color: #8b2252;">"&#1058;&#1091;&#1088;&#1080;&#1079;&#1084;, &#1075;&#1086;&#1089;&#1090;&#1080;&#1085;&#1080;&#1094;&#1099;, &#1088;&#1077;&#1089;&#1090;&#1086;&#1088;&#1072;&#1085;&#1099;"</span> . (<span style="color: #8b2252;">"22"</span>))
    (<span style="color: #8b2252;">"&#1070;&#1088;&#1080;&#1089;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"23"</span>))
    (<span style="color: #8b2252;">"&#1057;&#1087;&#1086;&#1088;&#1090;&#1080;&#1074;&#1085;&#1099;&#1077; &#1082;&#1083;&#1091;&#1073;&#1099;, &#1092;&#1080;&#1090;&#1085;&#1077;&#1089;, &#1089;&#1072;&#1083;&#1086;&#1085;&#1099; &#1082;&#1088;&#1072;&#1089;&#1086;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"24"</span>))
    (<span style="color: #8b2252;">"&#1048;&#1085;&#1089;&#1090;&#1072;&#1083;&#1083;&#1103;&#1094;&#1080;&#1103; &#1080; &#1089;&#1077;&#1088;&#1074;&#1080;&#1089;"</span> . (<span style="color: #8b2252;">"25"</span>))
    (<span style="color: #8b2252;">"&#1047;&#1072;&#1082;&#1091;&#1087;&#1082;&#1080;"</span> . (<span style="color: #8b2252;">"26"</span>))
    (<span style="color: #8b2252;">"&#1053;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1072;&#1088;&#1100;&#1077;&#1088;&#1099;, &#1089;&#1090;&#1091;&#1076;&#1077;&#1085;&#1090;&#1099;"</span> . (<span style="color: #8b2252;">"15"</span>))
    (<span style="color: #8b2252;">"&#1044;&#1086;&#1084;&#1072;&#1096;&#1085;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"27"</span>))
    (<span style="color: #8b2252;">"&#1056;&#1072;&#1073;&#1086;&#1095;&#1080;&#1081; &#1087;&#1077;&#1088;&#1089;&#1086;&#1085;&#1072;&#1083;"</span> . (<span style="color: #8b2252;">"29"</span>))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2-9" class="outline-3">
<h3 id="sec-2-9"><span class="section-number-3">2.9</span> Получение страниц</h3>
<div class="outline-text-3" id="text-2-9">
<p>
Вот так мы можем получать страницы, к примеру те, на который находятся тизеры:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_get_page">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-get-page</span> (url)
  <span style="color: #8b2252;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;"</span>
  (flexi-streams:octets-to-string
   (drakma:http-request url
                        <span style="color: #483d8b;">:user-agent</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:34.0) Gecko/20100101 Firefox/34.0"</span>
                        <span style="color: #483d8b;">:additional-headers</span> `((<span style="color: #8b2252;">"Accept"</span> . <span style="color: #8b2252;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
                                              (<span style="color: #8b2252;">"Accept-Language"</span> . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
                                              (<span style="color: #8b2252;">"Accept-Charset"</span> . <span style="color: #8b2252;">"utf-8"</span>)
                                              (<span style="color: #8b2252;">"Referer"</span> . <span style="color: #8b2252;">"http://spb.hh.ru/"</span>)
                                              (<span style="color: #8b2252;">"Cookie"</span> . <span style="color: #8b2252;">"redirect_host=spb.hh.ru; regions=2; __utma=192485224.1206865564.1390484616.1410378170.1417257232.29; __utmz=192485224.1390484616.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none); _xsrf=85014f262b894a1e9fc57b4b838e48e8; hhtoken=ES030IVQP52ULPbRqN9DQOcMIR!T; hhuid=x_FxSYWUbySJe1LhHIQxDA--; hhrole=anonymous; GMT=3; display=desktop; unique_banner_user=1418008672.846376826735616"</span>)
                                              (<span style="color: #8b2252;">"Cache-Control"</span> . <span style="color: #8b2252;">"max-age=0"</span>))
                        <span style="color: #483d8b;">:force-binary</span> t)
   <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-10" class="outline-3">
<h3 id="sec-2-10"><span class="section-number-3">2.10</span> Разбор тизеров вакансий</h3>
<div class="outline-text-3" id="text-2-10">
<p>
Чтобы получить вакансии со страниц поисковой выдачи - воспользуемся парсером,
который переведет полученный html в более удобное лисп-дерево. Используя сопоставление с
образцом мы раз за разом преобразуем его до тех пор, пока там не остануться только
интересующие нас данные:
</p>
<ul class="org-ul">
<li>название вакансии
</li>
<li>идентификатор (ссылку)
</li>
<li>дата размещения
</li>
<li>название работодателя
</li>
<li>идентификатор работодателя
</li>
</ul>

<p>
Если в вакансии указана зарплата, мы также получаем
</p>
<ul class="org-ul">
<li>Валюту зарплаты (3х-буквенный идентификатор)
</li>
<li>Сумму
</li>
<li>Текстовое выражение, содержащее "от" или "от и до"
</li>
</ul>

<p>
Иногда HeadHunter синдицирует вакансии с других платформ, к примеру с CAREER.RU, тогда в
вакансии может отсутствовать работодатель.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy_teasers">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;maptree_transform&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy-teasers</span> (html)
  <span style="color: #8b2252;">"&#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081; &#1080;&#1079; html"</span>
  (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result"</span>) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__results"</span>)) ,@rest) rest)
       (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"data-qa"</span> ,_) (<span style="color: #8b2252;">"class"</span> ,(or <span style="color: #8b2252;">"search-result-item search-result-item_premium  search-result-item_premium"</span>
                                                   <span style="color: #8b2252;">"search-result-item search-result-item_standard "</span>
                                                   <span style="color: #8b2252;">"search-result-item search-result-item_standard_plus "</span>))) ,@rest)
              (<span style="color: #a020f0;">let</span> ((in (remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (or (equal x 'z) (equal x <span style="color: #8b2252;">"noindex"</span>) (equal x <span style="color: #8b2252;">"/noindex"</span>))) rest)))
                (<span style="color: #a020f0;">if</span> (not (equal 1 (length in)))
                    (<span style="color: #a020f0;">progn</span> (print in)
                           (err <span style="color: #8b2252;">"parsing failed, data printed"</span>))
                    (car in))))
            (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__label HH-VacancyResponseTrigger-Text g-hidden"</span>)
                         (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_responded"</span>)) <span style="color: #8b2252;">"&#1042;&#1099; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1083;&#1080;&#1089;&#1100;"</span>) 'Z)
                 (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"title"</span> <span style="color: #8b2252;">"&#1055;&#1088;&#1077;&#1084;&#1080;&#1103; HRBrand"</span>) (<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"rel"</span> <span style="color: #8b2252;">"nofollow"</span>)
                              (<span style="color: #8b2252;">"class"</span> ,_)
                              (<span style="color: #8b2252;">"data-qa"</span> ,_)) <span style="color: #8b2252;">"&#160;"</span>) 'Z)
                      (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__image"</span>)) ,_) 'Z)
                           (mtm (`(<span style="color: #8b2252;">"script"</span> ((<span style="color: #8b2252;">"data-name"</span> <span style="color: #8b2252;">"HH/VacancyResponseTrigger"</span>) (<span style="color: #8b2252;">"data-params"</span> <span style="color: #8b2252;">""</span>))) 'Z)
                                (mtm (`(<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,_) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__label HH-VacancyResponseTrigger-Text g-hidden"</span>)
                                             (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_responded"</span>)) <span style="color: #8b2252;">"&#1042;&#1099; &#1086;&#1090;&#1082;&#1083;&#1080;&#1082;&#1085;&#1091;&#1083;&#1080;&#1089;&#1100;"</span>) 'Z)
                                     (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__star"</span>))) 'Z)
                                          (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__description"</span>)) ,@rest)
                                                 (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item <span style="color: #483d8b;">:in</span> rest <span style="color: #483d8b;">:when</span> (consp item) <span style="color: #483d8b;">:append</span> item))
                                               (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__head"</span>))
                                                             (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"class"</span> ,(or <span style="color: #8b2252;">"search-result-item__name search-result-item__name_standard"</span>
                                                                                 <span style="color: #8b2252;">"search-result-item__name search-result-item__name_standard_plus"</span>
                                                                                 <span style="color: #8b2252;">"search-result-item__name search-result-item__name_premium"</span>))
                                                                   (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-title"</span>) (<span style="color: #8b2252;">"href"</span> ,id) (<span style="color: #8b2252;">"target"</span> <span style="color: #8b2252;">"_blank"</span>)) ,name))
                                                      (list <span style="color: #483d8b;">:id</span> id <span style="color: #483d8b;">:name</span> name))
                                                    (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-list-salary"</span>) (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-compensation"</span>))
                                                                  (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"salaryCurrency"</span>) (<span style="color: #8b2252;">"content"</span> ,currency)))
                                                                  (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"baseSalary"</span>) (<span style="color: #8b2252;">"content"</span> ,salary))) ,salary-text)
                                                           (list <span style="color: #483d8b;">:currency</span> currency <span style="color: #483d8b;">:salary</span> salary <span style="color: #483d8b;">:salary-text</span> salary-text))
                                                         (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company"</span>)) ,emp-name)
                                                                (list <span style="color: #483d8b;">:emp-name</span> emp-name))
                                                              (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company"</span>))
                                                                            (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"href"</span> ,emp-id)
                                                                                  (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__company-link"</span>)
                                                                                  (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-employer"</span>))
                                                                                 ,emp-name))
                                                                     (list <span style="color: #483d8b;">:emp-id</span> emp-id <span style="color: #483d8b;">:emp-name</span> emp-name))
                                                                   (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result-item__info"</span>)) ,@rest)
                                                                          (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item <span style="color: #483d8b;">:in</span> rest <span style="color: #483d8b;">:when</span> (consp item) <span style="color: #483d8b;">:append</span> item))
                                                                        (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"searchresult__address"</span>)
                                                                                        (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-address"</span>)) ,city ,@rest)
                                                                               (<span style="color: #a020f0;">let</span> ((metro (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> item in rest <span style="color: #483d8b;">:do</span>
                                                                                               (<span style="color: #a020f0;">when</span> (and (consp item) (equal <span style="color: #483d8b;">:metro</span> (car item)))
                                                                                                 (<span style="color: #a020f0;">return</span> (cadr item))))))
                                                                                 (list <span style="color: #483d8b;">:city</span> city <span style="color: #483d8b;">:metro</span> metro)))
                                                                             (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"metro-station"</span>))
                                                                                            (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"metro-point"</span>) (<span style="color: #8b2252;">"style"</span> ,_))) ,metro)
                                                                                    (list <span style="color: #483d8b;">:metro</span> metro))
                                                                                  (mtm (`(<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-list-date"</span>)
                                                                                                  (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy-date"</span>)) ,date)
                                                                                         (list <span style="color: #483d8b;">:date</span> date))
                                                                                       (mtm (`(<span style="color: #8b2252;">"span"</span>
                                                                                               ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"vacancy-list-platform"</span>)
                                                                                                (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__vacancy_career"</span>))
                                                                                               <span style="color: #8b2252;">"&#160;&#160;&#8226;&#160;&#160;"</span> (<span style="color: #8b2252;">"span"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"vacancy-list-platform__name"</span>))
                                                                                                               <span style="color: #8b2252;">"CAREER.RU"</span>))
                                                                                              (list <span style="color: #483d8b;">:platform</span> 'career.ru))
                                                                                            (<span style="color: #a020f0;">block</span> subtree-extract
                                                                                              (mtm (`(<span style="color: #8b2252;">"div"</span>
                                                                                                      ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"search-result"</span>)
                                                                                                       (<span style="color: #8b2252;">"data-qa"</span> <span style="color: #8b2252;">"vacancy-serp__results"</span>))
                                                                                                      ,@rest)
                                                                                                     (<span style="color: #a020f0;">return-from</span> subtree-extract rest))
                                                                                                   (html5-parser:node-to-xmls
                                                                                                    (html5-parser:parse-html5-fragment html)))))))))))))))))))))))

(print
 <span style="color: #b22222;">;; </span><span style="color: #b22222;">(car</span>
  (hh-parse-vacancy-teasers
   (hh-get-page <span style="color: #8b2252;">"http://spb.hh.ru/search/vacancy?clusters=true&amp;specialization=1.221&amp;area=2&amp;page=12"</span>)))
</pre>
</div>
</div>

<div id="outline-container-sec-2-10-1" class="outline-4">
<h4 id="sec-2-10-1"><span class="section-number-4">2.10.1</span> Трансформация дерева</h4>
<div class="outline-text-4" id="text-2-10-1">
<div class="org-src-container">

<pre class="src src-lisp" id="maptree_transform">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1069;&#1090;&#1086; &#1072;&#1085;&#1072;&#1083;&#1086;&#1075; maptree-if, &#1085;&#1086; &#1079;&#1076;&#1077;&#1089;&#1100; &#1086;&#1076;&#1085;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1080; &#1080;&#1097;&#1077;&#1090; &#1080; &#1090;&#1088;&#1072;&#1085;&#1089;&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1090; &#1091;&#1079;&#1077;&#1083; &#1076;&#1077;&#1088;&#1077;&#1074;&#1072;</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree</span> (predicate-transformer tree)
  (<span style="color: #a020f0;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #a020f0;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #a020f0;">lambda</span> (x)
                     (maptree predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">maptree-transformer - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree</span>
(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">mtm</span> (transformer tree)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `(maptree #'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
                  (values (match ,lambda-param ,transformer)
                          #'mapcar))
              ,tree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-10-2" class="outline-4">
<h4 id="sec-2-10-2"><span class="section-number-4">2.10.2</span> <span class="todo WAIT">WAIT</span> Обход дерева и извлечение узлов</h4>
<div class="outline-text-4" id="text-2-10-2">
<p>
Чтобы эффективнее (с точки зрения скорости написания кода) разбирать вакансии мы
разберем всю полученную страницу в дерево, из которого будем извлекать необходимые нам
элементы.
</p>

<p>
Чтобы делать это будем обходить дерево, сопоставляя каждый узел с предикатом, в который
скомпилируется образец. Начнем с обхода дерева, для этого напишем рекурсивную функцию
<code>match-tree</code>, которую определим с помощью <code>labels</code>, чтобы окружить ее формой <code>let</code>
с аккумулятором.
</p>

<p>
Определим параметры этой функции:
</p>
<ul class="org-ul">
<li><code>tree</code> - под-дерево, которое мы рекурсивно обходим
</li>
<li><code>predict</code> - функция-предикат, которая может совпасть с обходимым поддеревом
</li>
<li><code>if-match</code> - параметр чтобы иметь возможность передавать <code>стратегию</code>. Про стратегии
поговорим чуть позже.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="cond_tree">(<span style="color: #a020f0;">labels</span> ((match-tree (tree f-predict <span style="color: #228b22;">&amp;optional</span> (if-match <span style="color: #483d8b;">:return-first-match</span>))
         (<span style="color: #a020f0;">cond</span> ((null tree) nil)
               ((atom tree) nil)
               (t
                &lt;&lt;cons&gt;&gt;))))
  &lt;&lt;call&gt;&gt;)
</pre>
</div>

<p>
Теперь переходим к рассмотрению плейсхолдера <code>cons</code>, который выполняет основную
работу. В первую очередь нам следует сравнить текущий узел с параметром <code>predict</code> и в
случае если <code>predict</code> вернул T - выполнить какие-то действия. В противном случае -
обрабатываем поддеревья этого узла.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="cons">(<span style="color: #a020f0;">if</span> (funcall f-predict tree)
    &lt;&lt;match_ok&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="sub_trees">(cons
 (funcall #'match-tree (car tree) f-predict if-match)
 (funcall #'match-tree (cdr tree) f-predict if-match))
</pre>
</div>

<p>
<b>Теперь о стратегиях</b>
</p>

<p>
В случае, когда узел совпал с <code>predict</code> мы можем реализовать следующие стратегии:
</p>
<ul class="org-ul">
<li>Немедленно вернуть совпавший узел и более не обрабатывать никакие узлы.
</li>
<li>Прекратить обработку всех подузлов совпавшего узла, запомнить его и перейти к обработке
следующего за ним.
</li>
<li>Запомнить совпавший узел и продолжить обработку вглубь совпавшего узла, а затем и всех
остальных узлов.
</li>
<li>Наиболее общий вариант - применить к сопавшему узлу переданную лямбда-функцию, которая
может с ним что-то сделать - например записать в какую-нибудь переменную на более
высоком уровне.
</li>
</ul>
<p>
Реализуем эти стратегии друг за другом.
</p>

<p>
Реализуем выбор стратегии в общих чертах - будем использовать <code>cond</code> по параметру
<code>if-match</code>. В случае, если в этом параметре не лежит keyword symbol с именем стратегии -
считаем, что там функция, если это не так - сигнализируем ошибку
<code>strategy-not-implemented</code> (которая пока нигде не определена - я считаю что ее имя
говорит само за себя).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="match_ok">(<span style="color: #a020f0;">cond</span> ((equal if-match <span style="color: #483d8b;">:return-first-match</span>)
       &lt;&lt;return_first_match&gt;&gt;)
      ((equal if-match <span style="color: #483d8b;">:return-first-level-match</span>)
       &lt;&lt;return_first_level_match&gt;&gt;)
      ((equal if-match <span style="color: #483d8b;">:return-all-match</span>)
       &lt;&lt;return_all_match&gt;&gt;)
      ((equal 'function (type-of if-match))
       (funcall if-match tree))
      (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'strategy-not-implemented)))
</pre>
</div>

<p>
Теперь приступим к реализации (первой) стратегии: немедленного возврата совпавшего
узла. Для этого нам понадобится определить внешнюю функцию <code>tree-match</code>, чтобы
возвращаться из нее, а не из текущего рекурсивного вызова <code>match-tree</code>. Мы сделаем это
несколько позже, а пока заполним плейсхолдер <code>return-first-match</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_match">(<span style="color: #a020f0;">return-from</span> tree-match tree)
</pre>
</div>

<p>
Теперь переходим ко второй стратегии - прекратить обработку всех подузлов сопавшего
узла, запомнить его и перейти к обработке следующего за ним. Нам понадобится переменная
<code>collect</code> чтобы хранить значения, запомним это и реализуем добавление узла в нее. После
того, как узел сохранен, мы не проводим обработку его под-деревьев, а переходим в
следующему узлу этого уровня.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_first_level_match">(setf collect
      (append collect (list tree)))
</pre>
</div>

<p>
И наконец, реализуем последнюю оставшуюся стратегию, которая представляет из себя
расширение предыдущей, но с обработкой вложенных узлов. Так и запишем:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="return_all_match">(<span style="color: #a020f0;">progn</span>
    &lt;&lt;return_first_level_match&gt;&gt;
    &lt;&lt;sub_trees&gt;&gt;)
</pre>
</div>

<p>
Теперь нам осталось лишь правильно возвращать результат. Если используются
аккумулирующие стратегии, то мы возвращаем содержимое переменной <code>collect</code>, в случае
немедленного возврата совпавшего узла мы никогда не окажемся в этом месте, а в случае
передачи в <code>if-match</code> лямбда-фукции - мы будем считать, что она как-нибудь сама
заботится о передачи значений. Поэтому всегда будем возвращать <code>collect</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="call">(match-tree tree predict if-match)
collect
</pre>
</div>

<p>
Осталось обернуть это все во внешнюю функцию, с аккумулятором:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="tree_match">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tree-match</span> (tree predict <span style="color: #228b22;">&amp;optional</span> (if-match <span style="color: #483d8b;">:return-first-match</span>))
  (<span style="color: #a020f0;">let</span> ((collect))
    &lt;&lt;cond_tree&gt;&gt;))
</pre>
</div>

<p>
Но для удобной работы этого недостаточно, поэтому напишем компилер шаблона в
соответствующий ему <code>predict</code>. Этот компилер будет принимать в качестве параметра форму,
которая будет связываться с элементами шаблона с помощью <code>destructuring-bind</code>. Попытка
связывания будет проводиться для каждого элемента дерева. Ошибки, которые возникают в
случае невозможности связывания, игнорируются.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict</span> (pattern <span style="color: #228b22;">&amp;body</span> body)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `#'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
         (<span style="color: #a020f0;">handler-case</span>
             (<span style="color: #a020f0;">destructuring-bind</span> ,pattern
                 ,lambda-param
               ,@body)
           (sb-kernel::arg-count-error nil)
           (sb-kernel::defmacro-bogus-sublist-error nil)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(with-predict (a ((b c)) d &amp;rest e)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(aif (and (string= a "div")</span>
<span style="color: #b22222;">;;              </span><span style="color: #b22222;">(string= c "title b-vacancy-title"))</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(prog1 it</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(setf **a** a)</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(setf **b** b)))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; #'(LAMBDA (LAMBDA-PARAM)</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(HANDLER-CASE</span>
<span style="color: #b22222;">;;            </span><span style="color: #b22222;">(DESTRUCTURING-BIND</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(A ((B C)) D &amp;REST E)</span>
<span style="color: #b22222;">;;                </span><span style="color: #b22222;">LAMBDA-PARAM</span>
<span style="color: #b22222;">;;              </span><span style="color: #b22222;">(AIF (AND (STRING= A "div") (STRING= C "title b-vacancy-title"))</span>
<span style="color: #b22222;">;;                   </span><span style="color: #b22222;">(PROG1 IT (SETF **A** A) (SETF **B** B))))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(SB-KERNEL::ARG-COUNT-ERROR NIL)</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(SB-KERNEL::DEFMACRO-BOGUS-SUBLIST-ERROR NIL))), T</span>
</pre>
</div>

<p>
Вот так, к примеру, это можно совместить с поиском по дереву:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(tree-match '(<span style="color: #8b2252;">"div"</span>
              ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>
                (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
                (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
                (<span style="color: #8b2252;">"table"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l"</span>))
                         (<span style="color: #8b2252;">"tr"</span> NIL
                               (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"colspan"</span> <span style="color: #8b2252;">"2"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))
                               (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))))))
              ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"g-round plus"</span>))`
              (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>))))
            (<span style="color: #a020f0;">with-predict</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
              (aif (and (stringp a)
                        (string= a <span style="color: #8b2252;">"class"</span>))
                   (<span style="color: #a020f0;">prog1</span> it
                     (setf **a** a)
                     (setf **b** b))))
            <span style="color: #483d8b;">:return-all-match</span>)
</pre>
</div>

<p>
Для еще большей лаконичности мы можем определить оборачивающий макрос, который позволит
нам не писать ничего, кроме условия в <code>aif</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="with_predict_if">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;with_predict&gt;&gt;

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict-if</span> (pattern <span style="color: #228b22;">&amp;body</span> condition)
  `(<span style="color: #a020f0;">with-predict</span> ,pattern
     (aif ,@condition
          (<span style="color: #a020f0;">prog1</span> it
            ,@(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                          `(setf ,(intern (format nil <span style="color: #8b2252;">"**~A**"</span> (symbol-name x))) ,x))
                      (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                     (or (equal x '<span style="color: #228b22;">&amp;rest</span>)
                                         (equal x '<span style="color: #228b22;">&amp;optional</span>)
                                         (equal x '<span style="color: #228b22;">&amp;body</span>)
                                         (equal x '<span style="color: #228b22;">&amp;key</span>)
                                         (equal x '<span style="color: #228b22;">&amp;allow-other-keys</span>)
                                         (equal x '<span style="color: #228b22;">&amp;environment</span>)
                                         (equal x '<span style="color: #228b22;">&amp;aux</span>)
                                         (equal x '<span style="color: #228b22;">&amp;whole</span>)
                                         (equal x '<span style="color: #228b22;">&amp;allow-other-keys</span>)))
                                 (alexandria:flatten pattern)))))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1 '</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(with-predict-if (a b &amp;rest c)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(and (stringp a)</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(string= a "class"))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (WITH-PREDICT (A B &amp;REST C)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(AIF (AND (STRINGP A) (STRING= A "class"))</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">(PROG1 IT</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **A** A)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **B** B)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(SETF **C** C))))</span>
</pre>
</div>

<p>
Таким образом мы инжектируем переменные шаблона в глобальную область видимости, если они
не определены в более высокоуровневом <code>let</code>.
</p>

<p>
Теперь мы можем использовать <code>tree-match</code> так:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(print
 (tree-match '(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>))
               (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)))
               (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) <span style="color: #8b2252;">"&#1042;&#1077;&#1076;&#1091;&#1097;&#1080;&#1081; android-&#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1095;&#1080;&#1082;"</span>)
               (<span style="color: #8b2252;">"table"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l"</span>))
                (<span style="color: #8b2252;">"tbody"</span> NIL
                 (<span style="color: #8b2252;">"tr"</span> NIL
                       (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"colspan"</span> <span style="color: #8b2252;">"2"</span>) (<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>))
                             (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"employer-marks g-clearfix"</span>))
                                    (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"companyname"</span>))
                                           (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"hiringOrganization"</span>) (<span style="color: #8b2252;">"href"</span> <span style="color: #8b2252;">"/employer/1529644"</span>))
                                                <span style="color: #8b2252;">"&#1054;&#1054;&#1054; &#1053;&#1080;&#1084;&#1073;&#1083;"</span>))))
                       (<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-cell"</span>)))))))
             (<span style="color: #a020f0;">with-predict-if</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
               (and (stringp a)
                    (string= a <span style="color: #8b2252;">"class"</span>)))
             <span style="color: #483d8b;">:return-all-match</span>))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (("class" "b-vacancy-custom g-round") ("class" "title b-vacancy-title")</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">("class" "l") ("class" "l-cell") ("class" "employer-marks g-clearfix")</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">("class" "companyname") ("class" "l-cell"))</span>

(print **b**)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; "l-cell"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2-11" class="outline-3">
<h3 id="sec-2-11"><span class="section-number-3">2.11</span> Разбор вакансий</h3>
<div class="outline-text-3" id="text-2-11">
<p>
Теперь, можно написать функцию, которая трансформирует описание, очищая его от всего
лишнего:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="transform_description">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">transform-description</span> (tree-descr)
  (<span style="color: #a020f0;">let</span> ((result)
        (header))
    (mapcar #'(<span style="color: #a020f0;">lambda</span> (item)
                (<span style="color: #a020f0;">unless</span> (equal <span style="color: #8b2252;">" "</span> item)
                  (<span style="color: #a020f0;">cond</span> ((and (null header) (consp item) (equal 1 (length item)))
                         (setf header (car item)))
                        ((and (not (null header)) (consp item) (not (equal 1 (length item))))
                         (<span style="color: #a020f0;">progn</span>
                           (setf result (append result (list (list header item))))
                           (setf header nil)))
                        (t (setf result (append result (list item)))))))
            (mtm (`<span style="color: #8b2252;">" "</span> 'Z)
                 (mtm (`(<span style="color: #8b2252;">"br"</span> NIL) 'Z)
                      (mtm (`(,(or <span style="color: #8b2252;">"ul"</span> <span style="color: #8b2252;">"p"</span>) NIL ,@rest)
                             (remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (and (not (consp x)) (equal x <span style="color: #8b2252;">" "</span>))) rest))
                           (mtm (`(,(or <span style="color: #8b2252;">"li"</span> <span style="color: #8b2252;">"em"</span>) NIL ,in) in)
                                (mtm (`(<span style="color: #8b2252;">"strong"</span> NIL ,in) in) *tree-descr*))))))
    (<span style="color: #a020f0;">labels</span> ((tmp (tree)
               (<span style="color: #a020f0;">cond</span>  ((consp tree) (remove-if #'(<span style="color: #a020f0;">lambda</span> (x) (equal x 'z))
                                               (cons (tmp (car tree))
                                                     (tmp (cdr tree)))))
                      (t tree))))
      (tmp result))))
</pre>
</div>

<p>
И, наконец, применим все что мы подготовили, чтобы разобрать вакансию:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_vacancy">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;transform_description&gt;&gt;

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-parse-vacancy</span> (html <span style="color: #228b22;">&amp;optional</span> intree)
  (<span style="color: #a020f0;">let*</span> ((tree (aif intree
                    it
                    (html5-parser:node-to-xmls (html5-parser:parse-html5-fragment html)))))
    (append (<span style="color: #a020f0;">block</span> header-extract
              (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-custom g-round"</span>)) (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"title"</span>) (<span style="color: #8b2252;">"content"</span> ,_)))
                            (<span style="color: #8b2252;">"h1"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"title b-vacancy-title"</span>)) ,name ,@archive) ,@rest)
                     (<span style="color: #a020f0;">return-from</span> header-extract
                       (append (list <span style="color: #483d8b;">:name</span> name <span style="color: #483d8b;">:archive</span> (<span style="color: #a020f0;">if</span> archive t nil))
                               (<span style="color: #a020f0;">block</span> emp-block (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"companyname"</span>)) (<span style="color: #8b2252;">"a"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"hiringOrganization"</span>) (<span style="color: #8b2252;">"href"</span> ,emp-lnk)) ,emp-name))
                                                       (<span style="color: #a020f0;">return-from</span> emp-block
                                                         (list <span style="color: #483d8b;">:emp-id</span> (parse-integer (car (last (split-sequence:split-sequence #\/ emp-lnk))) <span style="color: #483d8b;">:junk-allowed</span> t)
                                                               <span style="color: #483d8b;">:emp-name</span> emp-name))) rest)))))
                   tree))
            (<span style="color: #a020f0;">let</span> ((salary-result (<span style="color: #a020f0;">block</span> salary-extract
                                   (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>))
                                                 (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"salaryCurrency"</span>) (<span style="color: #8b2252;">"content"</span> ,currency)))
                                                 (<span style="color: #8b2252;">"meta"</span> ((<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"baseSalary"</span>) (<span style="color: #8b2252;">"content"</span> ,base-salary)))
                                                 ,salary-text)
                                          (<span style="color: #a020f0;">return-from</span> salary-extract (list <span style="color: #483d8b;">:currency</span> currency <span style="color: #483d8b;">:base-salary</span> base-salary <span style="color: #483d8b;">:salary-text</span> salary-text)))
                                        tree))))
              (<span style="color: #a020f0;">if</span> (equal 6 (length salary-result))
                  salary-result
                  (list <span style="color: #483d8b;">:currency</span> nil <span style="color: #483d8b;">:base-salary</span> nil <span style="color: #483d8b;">:salary-text</span> nil)))
            (<span style="color: #a020f0;">let</span> ((city-result (<span style="color: #a020f0;">block</span> city-extract (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-content-colum-2 b-v-info-content"</span>)) (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>)) ,city))
                                                          (<span style="color: #a020f0;">return-from</span> city-extract (list <span style="color: #483d8b;">:city</span> city))) tree))))
              (<span style="color: #a020f0;">if</span> (equal 2 (length city-result)) city-result (list <span style="color: #483d8b;">:city</span> nil)))
            (<span style="color: #a020f0;">let</span> ((exp-result (<span style="color: #a020f0;">block</span> exp-extract (mtm (`(<span style="color: #8b2252;">"td"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-content-colum-3 b-v-info-content"</span>))
                                                              (<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"l-paddings"</span>) (<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"experienceRequirements"</span>)) ,exp))
                                                        (<span style="color: #a020f0;">return-from</span> exp-extract (list <span style="color: #483d8b;">:exp</span> exp))) tree))))
              (<span style="color: #a020f0;">if</span> (equal 2 (length exp-result)) exp-result (list <span style="color: #483d8b;">:exp</span> nil)))
            (<span style="color: #a020f0;">block</span> descr-extract
              (mtm (`(<span style="color: #8b2252;">"div"</span> ((<span style="color: #8b2252;">"class"</span> <span style="color: #8b2252;">"b-vacancy-desc-wrapper"</span>) (<span style="color: #8b2252;">"itemprop"</span> <span style="color: #8b2252;">"description"</span>)) ,@descr)
                     (<span style="color: #a020f0;">return-from</span> descr-extract (list <span style="color: #483d8b;">:descr</span> <span style="color: #b22222;">#|(transform-description|#</span> descr <span style="color: #b22222;">#|)|#</span>))) tree)))))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(hh-parse-vacancy (hh-get-page "http://spb.hh.ru/vacancy/12561525")))</span>

(print
 (hh-parse-vacancy (hh-get-page <span style="color: #8b2252;">"http://spb.hh.ru/vacancy/12581768"</span>)))
</pre>
</div>
</div>

<div id="outline-container-sec-2-11-1" class="outline-4">
<h4 id="sec-2-11-1"><span class="section-number-4">2.11.1</span> <span class="todo WAIT">WAIT</span> Сопоставление и преобразование узлов</h4>
<div class="outline-text-4" id="text-2-11-1">
<p>
Разбирая вакансию мы должны извлечь несколько блоков:
</p>
<ul class="org-ul">
<li>блок заголовка
</li>
<li>общие данные, такие как уровень зарплаты, город, требуемый опыт работы
</li>
<li>собственно описание вакансии
</li>
</ul>
<p>
Из каждого блока будем извлекать конкретные данные, возвращаемы как plist.
</p>

<p>
Описание вакансии представляет из себя дерево, в котором нам важна структура, так как
требования, обязанности и прочее описываются списком. В этом списке много лишнего
форматирования, для удаления которого нам необходимо уметь преобразовывать дерево.
</p>

<p>
Напишем для этого рекурсивный преобразователь, который возвращает новое дерево,
рекурсивно вызывая аргумент <code>transformer</code> на <code>sub-tree</code>, которые удовлетворяют аргументу
<code>predicate</code>.
</p>

<p>
Аргумент <code>predicate</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает T или NIL
</p>

<p>
Аргумент <code>transformer</code> должен быть лямбда-функцией, которая принимает на вход <code>subtree</code> и
возвращает <code>atom</code> или <code>subtree</code> в первом параметре, а во втором может возвратить функцию
<code>control</code>. Если эта функция возвращена, тогда дерево возвращается с замененным
<code>transformer</code>-ом узлами по следующему алгоритму:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(funcall control
         #'(<span style="color: #a020f0;">lambda</span> (x)
             (maptree-if predicate transformer x))
         transformed-tree)
</pre>
</div>

<p>
В противном случае оно возвращается как есть.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree-if</span> (predicate transformer tree)
  (<span style="color: #a020f0;">multiple-value-bind</span> (t-tree control)
      (<span style="color: #a020f0;">if</span> (funcall predicate tree)
          (funcall transformer tree)
          (values tree #'mapcar))
    (<span style="color: #a020f0;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #a020f0;">lambda</span> (x)
                     (maptree-if predicate transformer x))
                 t-tree)
        t-tree)))
</pre>
</div>

<p>
Несколько примеров работы:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1053;&#1077;&#1088;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                `(pong ,@(cdr x)))
            '(<span style="color: #a020f0;">progn</span> (ping (ping (ping 1)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (PROGN (PONG (PING (PING 1))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1056;&#1077;&#1082;&#1091;&#1088;&#1089;&#1080;&#1074;&#1085;&#1072;&#1103; &#1079;&#1072;&#1084;&#1077;&#1085;&#1072;</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (eq (car x) 'ping)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                (values `(pong ,@(cdr x)) #'mapcar))
            '(<span style="color: #a020f0;">progn</span> (ping (ping (ping 1)))
              ping))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (PROGN (PONG (PONG (PONG 1))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1055;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1089;&#1086;&#1074;&#1084;&#1077;&#1089;&#1090;&#1085;&#1086; &#1089; with-predict-if &#1080; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;&#1084; **&#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1093;**</span>
(maptree-if #'(<span style="color: #a020f0;">lambda</span> (x)
                (and (consp x)
                     (funcall (<span style="color: #a020f0;">with-predict-if</span> (a b <span style="color: #228b22;">&amp;rest</span> c)
                                (and (equal b 'ping)))
                              x)))
            #'(<span style="color: #a020f0;">lambda</span> (x)
                (values `(,**a** pong ,@(cddr x)) #'mapcar))
            '(<span style="color: #a020f0;">progn</span> (ping (ping ping (ping 1)))
              ping))
</pre>
</div>

<p>
И макрос для более лаконичной записи того же:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-predict-maptree</span> (pattern condition replace tree)
  (<span style="color: #a020f0;">let</span> ((lambda-param (gensym)))
    `(maptree-if #'(<span style="color: #a020f0;">lambda</span> (,lambda-param)
                     (and (consp ,lambda-param)
                        (funcall (<span style="color: #a020f0;">with-predict-if</span> ,pattern
                                   ,condition)
                                 ,lambda-param)))
                 ,replace
                 ,tree)))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(macroexpand-1</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">'(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(and (equal b 'ping))</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">#'(lambda (x)</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">'(progn (ping (ping ping (ping 1))) ping)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(with-predict-maptree (a b &amp;rest c)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(and (equal b 'ping))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">#'(lambda (x)</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(values `(,**a** pong ,@(cddr x)) #'mapcar))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">'(progn (ping (ping ping (ping 1))) ping))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2-12" class="outline-3">
<h3 id="sec-2-12"><span class="section-number-3">2.12</span> <span class="todo TODO">TODO</span> Незавершенное</h3>
<div class="outline-text-3" id="text-2-12">
<p>
Здесь стоит остановиться и спросить себя - все ли понятно. Если что-то непонятно, следует
открыть файл, например, в емаксте, т.к. в гитхабе про отображении файла не видно имен
блоков кода.
</p>
</div>

<div id="outline-container-sec-2-12-1" class="outline-4">
<h4 id="sec-2-12-1"><span class="section-number-4">2.12.1</span> Сохранение данных</h4>
<div class="outline-text-4" id="text-2-12-1">
<p>
Как только у нас это есть - код становится простым
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse"><span style="color: #b22222;">;; </span><span style="color: #b22222;">(in-package #:moto)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defparameter *programmin-and-development-profile*</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(make-profile :name "&#1055;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077; &#1080; &#1088;&#1072;&#1079;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1072;"</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">:user-id 1</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">:search-query "http://spb.hh.ru/search/vacancy?clusters=true&amp;specialization=1.221&amp;area=2&amp;page=~A"</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">:ts-create (get-universal-time)</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">:ts-last (get-universal-time)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defun run-collect (profile)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let* ((search-str   (search-query profile))</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(all-teasers  nil))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">(block get-all-hh-teasers</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(loop :for num :from 0 :to 100 :do</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(print num)</span>
<span style="color: #b22222;">;;          </span><span style="color: #b22222;">(let* ((url (format nil search-str num))</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(teasers (hh-parse-vacancy-teasers (hh-get-page url))))</span>
<span style="color: #b22222;">;;            </span><span style="color: #b22222;">(if (equal 0 (length teasers))</span>
<span style="color: #b22222;">;;                </span><span style="color: #b22222;">(return-from get-all-hh-teasers)</span>
<span style="color: #b22222;">;;                </span><span style="color: #b22222;">(setf all-teasers (append all-teasers teasers)))))</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">(print "over-100"))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">all-teasers))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; (print</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;;  (hh-parse-vacancy-teasers (hh-get-page "http://spb.hh.ru/search/vacancy?clusters=true&amp;specialization=1.221&amp;area=2&amp;page=28")))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defparameter *teasers* (run-collect *programmin-and-development-profile*))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; (length *teasers*)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defun save-collect (all-teasers)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(loop :for tea :in all-teasers :do</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(print tea)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">(make-vacancy :profile-id (id *programmin-and-development-profile*)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:name (getf tea :vac-name)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:rem-id (parse-integer</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(car (last (split-sequence:split-sequence</span>
<span style="color: #b22222;">;;                                         </span><span style="color: #b22222;">#\/ (getf tea :vac-id)))))</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:rem-date (getf tea :vacancy-date)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:rem-employer-name (getf tea :employer-name)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:rem-employer-id (aif (getf tea :employer-id)</span>
<span style="color: #b22222;">;;                                          </span><span style="color: #b22222;">(parse-integer</span>
<span style="color: #b22222;">;;                                           </span><span style="color: #b22222;">(car (last (split-sequence:split-sequence</span>
<span style="color: #b22222;">;;                                                       </span><span style="color: #b22222;">#\/ it))))</span>
<span style="color: #b22222;">;;                                          </span><span style="color: #b22222;">0)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:currency (getf tea :currency)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:salary (aif (getf tea :salary)</span>
<span style="color: #b22222;">;;                                 </span><span style="color: #b22222;">it</span>
<span style="color: #b22222;">;;                                 </span><span style="color: #b22222;">0)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:salary-text (getf tea :salary-text)</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">:state ":TEASER"</span>
<span style="color: #b22222;">;;                    </span><span style="color: #b22222;">)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(save-collect *teasers*)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; (length (all-vacancy))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; (print</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">;;  (hh-parse-vacancy (hh-get-page (format nil "http://spb.hh.ru/vacancy/~A" (rem-id (get-vacancy 1))))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">;; (car *teasers*)</span>
</pre>
</div>

<p>
Теперь мы сохранили тизеры. Когда в интерфейсе мы определим, какие вакансии нас
интересуют больше чем остальные их можно будет получить по статусу:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_parse_deep">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(find-vacancy :profile-id 1)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(all-vacancy)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-12-2" class="outline-4">
<h4 id="sec-2-12-2"><span class="section-number-4">2.12.2</span> Состояния вакансии</h4>
</div>
<div id="outline-container-sec-2-12-3" class="outline-4">
<h4 id="sec-2-12-3"><span class="section-number-4">2.12.3</span> Еще кое-что</h4>
<div class="outline-text-4" id="text-2-12-3">
<p>
После отправки отклика звонит работодатель и приглашает на интервью. Но это уже
интерфейсная часть.
</p>

<p>
В этот момент я хочу [найти вакансию], глянуть ее и в зависимости от того до чего мы
договорились с работодателем выставить ей некоторое состояние.
</p>

<p>
Я также хочу чтобы система проходила по вакансиям и в зависимости от сочетания условий
выполняла какие-то действия
</p>

<ul class="org-ul">
<li>напоминание мне о собеседованиях, звонках (календарь)
</li>
<li>автоматическое ранжирование вакансий (по перспективам найма, зарплате и.т.п)
</li>
</ul>

<p>
Система анализирует компании с т.з. выставляемых вакансий и формирует профиль
компании. По выставляемым вакансиям можно сделать интересные выводы - например когда у
компании внезапно появляются вакансии на одного сеньера и нескольких линейных
разработчиков - это напоминает открытие нового отдела/проекта.
</p>

<p>
Система классифицирует сохраненные вакансии по формальным признакам, таким как:
</p>
<ul class="org-ul">
<li>новые вакансии
</li>
<li>измененные
</li>
<li>закрытые (о закрытости вакансии можно судить по ряду критериев)
</li>
<li>особенно интересные
</li>
<li>необычные
</li>
</ul>

<p>
В случае изменений или появления новых интересующих пользователя вакансий пользователю отправляется
уведомление (через систему очередей сообщений и по email).
</p>

<p>
Исходя из анализа DESCRIPTION можно определить требуемую технологию и требуемую степень
владения ею.
</p>

<p>
Предоставление рекомендаций и отбор вакансий на основе модифицируемых правил и фактах
предметной области, таких как "работодатель - компания по разработке ПО" или "ИТ-поддержка
не является приоритетом компании"
</p>

<p>
Предсказание поведения (путей достижения целей) компании (в процессе найма и вне его) на
основе моделей и целей.
</p>

<p>
Выбор вариантов поведения в ответ на предьявляемые требования (цикл распознавание-действие
в продукционной системе)
</p>

<p>
Построение концептуальных моделей и преобразования в них - выбор стратегии действий и
постановка целей
</p>

<p>
Выбор способа представления знаний (правила, фреймы, концептуальные графы)
</p>

<p>
Выбор стратегии поиска
</p>

<p>
Включение терма из набора технологий в заголовке вакансии - присвоение классификатора
(тега)
</p>

<p>
Правила вывода - сопоставление с профилем
</p>

<p>
Вычисление различий (дифф) требований и профильных навыков
</p>

<p>
Интерактивное построение профиля (ответы на вопросы). Необходим видимый прогресс и
предварительная классификация предложений
</p>

<p>
Построение новых правил на основе известных
</p>
</div>
</div>

<div id="outline-container-sec-2-12-4" class="outline-4">
<h4 id="sec-2-12-4"><span class="section-number-4">2.12.4</span> Для красоты</h4>
<div class="outline-text-4" id="text-2-12-4">
<p>
Хотелось бы чтобы в сгенерированном html можно было сворачивать куски исходников, ну и
красивую подсветку. Также нужны имена кусков.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Хотелки</h2>
<div class="outline-text-2" id="text-3">
<p>
Мы все ищем работу на профильных сайтах, но, к сожалению, не всегда на них хватает
функционала, особенно нестандартного. Работая с сайтом в автоматическом режиме мы можем
восполнить этот пробел.
</p>

<p>
Кроме того есть множество конкурирующих сайтов для поиска работы, информацию с которых
можно аггрегировать.
</p>

<p>
При поиске работы основной сценарий использования - <code>поиск вакансий</code>, и практически все
сайты его предоставляют. Однако мне бы хотелось дополнительно иметь дополнительный
функционал:
</p>

<ul class="org-ul">
<li>заметки по каждой вакансии
</li>
<li>статусы или теги, такие как:
<ul class="org-ul">
<li><code>просмотрено</code> (с датой),
</li>
<li><code>отобрано</code>,
</li>
<li><code>не-берут-трубку</code>,
</li>
<li><code>не-актуально</code>,
</li>
<li><code>приглашен-на-интервью</code>,
</li>
<li><code>выслали-тестовое-задание</code>,
</li>
<li><code>отправил-тестовое-задание</code>,
</li>
<li><code>получен-оффер</code>,
</li>
<li><code>вакансия-закрыта</code> итп.
</li>
</ul>
</li>
</ul>

<p>
Я бы хотел ранжировать вакансии вручную (по выставленным приоритетам) и автоматически
(т.е. скриптом), например в зависимости от зарплаты или удаленности.
</p>

<p>
Я бы хотел иметь возможность планировать маршрут, когда еду на собеседование и иметь
календарь, чтобы не пропустить встречу.
</p>

<p>
Я бы хотел иметь версии вакансий, чтобы отслеживать их изменения, например изменения
зарплаты до и после моего интервью - это позволит анализировать рынок и получать больше
информации.
</p>

<p>
Мне также интересно составлять профили компаний и отслеживать как меняется набор
сотрудников которых они ищут - это поможет планировать долгосрочную стратегию. Особенно в
этом плане интересны лидеры рынка - Яндекс, Гугл и.т.п.
</p>

<p>
Я бы хотел иметь возможность пообщаться с теми кто работал или работает в интересующей
меня компании, иметь подмножество функционала социальных сетей или интеграцию с ними
</p>

<p>
Иногда мне приятно работать с уже знакомыми людьми, так что в целом я бы не отказался
создавать на таком сайте что-то типа т.н. <code>рабочих коллективов</code>, чтобы наниматься сразу
командой. Возможно работодателям такой вариант найма тоже будет интересен.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Процесс найма с т.з. соискателя</h3>
<div class="outline-text-3" id="text-3-1">
<p>
С точки зрения соискателя процесс найма выглядит так:
</p>

<ul class="org-ul">
<li>Этап составления резюме
</li>
<li>Этап опубликования резюме
</li>
<li>Этап поиска
<ul class="org-ul">
<li>Поиск и просмотр вакансий, отсев, ранжирование
</li>
<li>Рассылка откликов
</li>
</ul>
</li>
<li>Этап телефонных переговоров
<ul class="org-ul">
<li>Получение звонков, обсуждение деталей по телефону
</li>
<li>Договоренность о еще одном звонке
</li>
<li>Тестовое задание на почту
</li>
<li>Договоренность о skype-интервью
</li>
</ul>
</li>
<li>Этап удаленного тестирования
<ul class="org-ul">
<li>Skype-интервью
</li>
<li>Ожидание тестового задания
</li>
<li>Выполнение тестового задания
</li>
</ul>
</li>
<li>Этап очного собеседования
<ul class="org-ul">
<li>Приглашение на интервью
</li>
<li>Интервью
</li>
</ul>
</li>
<li>Этап отбора предложений
<ul class="org-ul">
<li>Получение предложений
</li>
<li>Выбор предложения
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Процесс найма с т.з. HR-а</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Когда HR-специалист ищет вакансии, он пользуется несколькими путями:
</p>
<ul class="org-ul">
<li>Личные знакомства
</li>
<li>Рекомендации
</li>
<li>Социальные сети
<ul class="org-ul">
<li>LinkedIn
</li>
<li>vkontakte
</li>
</ul>
</li>
<li>Помощь коллег
</li>
<li>Специализированные сайты
</li>
</ul>

<p>
Как правило, HR-специалист менее компетентен в предметной области, чем нанимаемый
сотрудник, поэтому для него имеет большой вес мнение рекомендателей и коллег
соискателя. Вероятно, рекомендательный сервис был бы очень актуален.
</p>

<p>
Компании-работодатели выбирают одну из моделей найма, в соответствии со своим бюджетом и
задачами:
</p>
<ul class="org-ul">
<li>Всегда (на любую позицию) нанимать (переманивать) лучших
</li>
<li>Нанимать начинающих в подчинение лучшим
</li>
<li>Нанимать начинающих (конвеерная разработка, большая текучка)
</li>
<li>Нанимать тех, кто понравится лидеру отдела
</li>
<li>Нанимать тех, кто лучше соответствует корпоративной культуре
</li>
</ul>

<p>
Для каждой из этих моделей характерны свои необходимые сервисы. К примеру, для модели
"нанимать лучших" совершенно необходимо вести и актуализировать базу этих "лучших", чтобы
вовремя сделать предложение кандидату. О примерах внедрения таких сервисов мне ничего не
известно. Также интересно уточнить у HR-специалистов из <code>разных</code> компаний их методы
работы.
</p>

<p>
Для HR-специалиста процесс найма выгядит (в общих чертах) так.
</p>

<ul class="org-ul">
<li>Этап составления вакансий
</li>
<li>Этап опубликования вакансий
</li>
<li>Этап поиска резюме
<ul class="org-ul">
<li>По ключевым словам
</li>
<li>По фильтру
</li>
<li>Используя автоподбор
</li>
</ul>
</li>
<li>Этап анализа откликов (неразобранные, подумать, приглашенные, отклоненные)
</li>
<li>Телефонный звонок соискателю (с целью уточнить детали или пригласить)
</li>
<li>Возможно отправка тестового задания
</li>
<li>Получение тестового задания
</li>
<li>Проверка тестового задания
</li>
<li>Скайп-интервью
</li>
<li>Этап собеседования
<ul class="org-ul">
<li>Опциоанльно: заполнение анкеты
</li>
<li>Собеседование с HR-специалистом (об условиях)
</li>
<li>Тесты (например: на знание языка, ООП, БД, многопоточность)
</li>
<li>Тестовое задание
</li>
<li>Проверка тестового задания
</li>
<li>Собеседование с тех. спецом, (как правило нач. отдела)
</li>
</ul>
</li>
</ul>

<p>
HR-специалист анализирует обратную связь о составляемых им вакансиях - у него есть
статистическая информация о кол-ве просмотров вакансий и количестве поступивших
откликов. Из этих данных можно, например, сделать вывод, что предложенная зарплата
неактуальна на рынке.
</p>

<p>
Также HR-специалист заинтересован в технической поддержке при решении задач типа:
</p>
<ul class="org-ul">
<li>Мониторинг резюме (сообщения о обновлении резюме, просмотр старой версии)
</li>
<li>Ведение базы кандидатов (часто в экселе)
</li>
</ul>

<p>
HR-специалист заинтересован в том, чтобы иметь возможность построить процесс найма под
себя.
</p>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Состояния вакансий</h3>
<div class="outline-text-3" id="text-3-3">
<p>
После того, как тизер вакансии будет загружен системой, вакансия получает статус <code>new</code> и
помечается в интерфейсе специальным значком, чтобы обратить на себя внимание
пользователя. В дальнейшем эти тизеры попадают на автоматическую и ручную сортировку и
могут принять один из статусов: <code>unsorted</code>, <code>interested</code> или <code>not-interested</code>
</p>

<p>
После того, как пользователь определился с интересными ему тизерами, он иницирует
загрузку полной информции о вакансиях и они становятся доступны для просмотра и внесения
заметок.
</p>

<p>
Пользователь, работая с этими интересными вакансиями, отслеживает их состояния, выполняя
действия, переводящие вакансию из одного состояния в другое: когда пользователь
отправляет отзыв  вакансия становится <code>responded</code>. Если пользователь, просмотрев
вакансию, принял решение отзыв не отправлять, он может сделать вакансию <code>hidden</code>.
</p>

<p>
Важно: Для обеспечения социальных взаимодействий нужно предусмотреть, чтобы вакансию
можно было "передать", т.е. у нее минимум должен быть URI.
</p>

<p>
Если пользователь просмотрел вакансию, но пока не хочет отправлять отзыв - он может
добавить вакансию в закладки - в этом случае ее статус меняется на <code>favorited</code>
</p>

<p>
Из <code>favorited</code> мы снова можем отправить отзыв.
</p>

<p>
Из <code>favorited</code> пользователь может вернуть вакансию обратно в <code>interested</code> или <code>hidden</code>.
</p>

<p>
Из <code>hidden</code> пользователь может вернуть вакансию в <code>interested</code>.
</p>

<p>
Если по вакансии позвонили, пользователю обычно нужно ее быстро найти. Нужна форма поиска
по вакансиям в статусе <code>responded</code> - пользователь ищет обычно по названию фирмы.
</p>

<p>
После звонка вакансия может быть выкинута или переведена из <code>responded</code> в статус "был
телефонный звонок" - <code>called</code>. Выкидывая вакансию пользователь может выбрать reason - для
них можно будет потом сделать отдельную таблицу но пока просто пишем в поле
вакансии. Если в результате телефонного звонка была достигнута договоренность о
собеседовании - пользователь переводит вакансию в состояние "пригласили на интервью" -
<code>wait-interview</code> и заносит в вакансию данные о том, куда и во сколько ехать. Если по
телефону рекрутер предложил тестовое задание - статус - "ожидание тестового задания" -
<code>wait-test</code>. Если договорились о интервью по скайпу - "ожидание скайп-интервью" -
<code>wait-skype-interview</code>.
</p>

<p>
Получив тестовое задание пользователь переводит вакансию из статуса <code>wait-test</code> в
"выполнение тестового задания" <code>run-test</code>, а оттуда либо в <code>test-cancel</code> либо в
<code>test-sended</code>. Либо выкидывает.
</p>

<p>
Пользователи иногда забивают на интервью (случаются накладки) - в этом случае рекрутер
часто передоговаривается на другое время. Делать петли в графе значит излишне усложнять
его, наверно пусть можно будет просто изменить данные о времени интервью.
</p>

<p>
После интервью или скайп-интервью от вакансии можно либо отказаться (<code>refuse-employer</code>,
<code>refuse-applicant</code>) либо перевести в статус "ожидание результата" - <code>wait-result</code>. Нужно
включать таймер, по истечении которого напоминать пользователю позвонить рекрутеру и
узнать, как дела.
</p>

<p>
Иногда после скайп-интервью назначают очное интервью. Также бывает прямо на интервью
предлагают оффер - <code>offer</code> и соискатель берет время на подумать.
</p>

<p>
Из "ожидания результата" можно перескочить в "предложен оффер", "отказ работодателя" -
<code>refuse-employer</code> или "отказ соискателя" - <code>refuse-аpplicant</code>.
</p>

<p>
История статусов нужна, в нее нужно заносить время когда изменяется статус и возможно
примечания по изменению. Будет красиво, если в интерфейсе будет отображаться полный граф
статусов и текущее положение вакансии в нем.
</p>

<table id="vacancy_state" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Состояния конечного автомата вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">action</th>
<th scope="col" class="left">from</th>
<th scope="col" class="left">to</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">view</td>
<td class="left">new</td>
<td class="left">unsorted</td>
</tr>

<tr>
<td class="left">refuse-new</td>
<td class="left">new</td>
<td class="left">not-interested</td>
</tr>

<tr>
<td class="left">set-interested</td>
<td class="left">new</td>
<td class="left">interested</td>
</tr>

<tr>
<td class="left">refuse-interested</td>
<td class="left">interested</td>
<td class="left">hidden</td>
</tr>

<tr>
<td class="left">respond</td>
<td class="left">interested</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">favor</td>
<td class="left">interested</td>
<td class="left">favorited</td>
</tr>

<tr>
<td class="left">send-respond-from-favorited</td>
<td class="left">favorited</td>
<td class="left">responded</td>
</tr>

<tr>
<td class="left">unfavor</td>
<td class="left">favorited</td>
<td class="left">interested</td>
</tr>

<tr>
<td class="left">hide-after-favor</td>
<td class="left">favorited</td>
<td class="left">hidden</td>
</tr>

<tr>
<td class="left">call</td>
<td class="left">responded</td>
<td class="left">called</td>
</tr>

<tr>
<td class="left">invite-interview</td>
<td class="left">called</td>
<td class="left">wait<sub>interview</sub></td>
</tr>

<tr>
<td class="left">invite-skype-interview</td>
<td class="left">called</td>
<td class="left">wait<sub>skype</sub><sub>interview</sub></td>
</tr>

<tr>
<td class="left">invite-test</td>
<td class="left">called</td>
<td class="left">wait<sub>test</sub></td>
</tr>

<tr>
<td class="left">interview</td>
<td class="left">wait<sub>interview</sub></td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">skype-interview</td>
<td class="left">wait<sub>skype</sub><sub>interview</sub></td>
<td class="left">skype<sub>interview</sub></td>
</tr>

<tr>
<td class="left">call-after-skype-interview</td>
<td class="left">skype<sub>interview</sub></td>
<td class="left">called</td>
</tr>

<tr>
<td class="left">execute-test</td>
<td class="left">wait<sub>test</sub></td>
<td class="left">run<sub>test</sub></td>
</tr>

<tr>
<td class="left">send-test</td>
<td class="left">run<sub>test</sub></td>
<td class="left">send<sub>test</sub></td>
</tr>

<tr>
<td class="left">called-after-test</td>
<td class="left">send<sub>test</sub></td>
<td class="left">called</td>
</tr>

<tr>
<td class="left">refuse-employer-after-interview</td>
<td class="left">interview</td>
<td class="left">refuse<sub>employer</sub></td>
</tr>

<tr>
<td class="left">refuse-applicant-after-interview</td>
<td class="left">interview</td>
<td class="left">refuse<sub>applicant</sub></td>
</tr>

<tr>
<td class="left">wait-result-after-interview</td>
<td class="left">interview</td>
<td class="left">wait<sub>result</sub></td>
</tr>

<tr>
<td class="left">refuse-employer-after-skype-interview</td>
<td class="left">skype<sub>interview</sub></td>
<td class="left">refuse<sub>employer</sub></td>
</tr>

<tr>
<td class="left">refuse-applicant-after-skype-interview</td>
<td class="left">skype<sub>interview</sub></td>
<td class="left">refuse<sub>applicant</sub></td>
</tr>

<tr>
<td class="left">wait-result-after-skype-interview</td>
<td class="left">skype<sub>interview</sub></td>
<td class="left">wait<sub>result</sub></td>
</tr>

<tr>
<td class="left">invite-next-interview</td>
<td class="left">wait<sub>result</sub></td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">invite-interview-after-skype</td>
<td class="left">skype<sub>interview</sub></td>
<td class="left">interview</td>
</tr>

<tr>
<td class="left">invite-offer</td>
<td class="left">wait<sub>result</sub></td>
<td class="left">offer</td>
</tr>

<tr>
<td class="left">employer-refuse-after-wait-result</td>
<td class="left">wait<sub>result</sub></td>
<td class="left">refuse<sub>employer</sub></td>
</tr>

<tr>
<td class="left">applicant-refuse-after-wait-result</td>
<td class="left">wait<sub>result</sub></td>
<td class="left">refuse<sub>applicant</sub></td>
</tr>
</tbody>
</table>

<p>
Теперь мы можем полностью описать поведение вакансии как конечный автомат:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="vacancy_state_graph">(mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
            (princ (format <span style="color: #8b2252;">"%s -&gt; %s [label =\"%s\"];\n"</span>
                           (second x) (third x) (first x))))
        table)
</pre>
</div>



<div class="figure">
<p><img src="img/vacancy-state.png" alt="vacancy-state.png" />
</p>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">teaser-rejection</span> ()
  <span style="color: #8b2252;">"teaser-rejection"</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">rejection-favorite</span> ()
  <span style="color: #8b2252;">"rejection-favorite"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Сценарии использования</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Пользовательские</h3>
<div class="outline-text-3" id="text-4-1">
</div><div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> Авторизация/регистрация</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Пользователь регистрируется и авторизуется для получения доступа к своем аккаунту. За
это отвечает модуль auth.
</p>
</div>
</div>

<div id="outline-container-sec-4-1-2" class="outline-4">
<h4 id="sec-4-1-2"><span class="section-number-4">4.1.2</span> Формализация предпочтений</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
Пользователь формулирует свои предпочтения относительно вакансий (и фирм их размещающих)
в виде некоторых формализованных утверждений.
</p>
</div>
</div>

<div id="outline-container-sec-4-1-3" class="outline-4">
<h4 id="sec-4-1-3"><span class="section-number-4">4.1.3</span> Отбор и сортировка вакансий</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
Пользователь отбирает интересные и неинтересные ему вакансии вручную и автоматически -
путем применения к ним скриптов
</p>
</div>
</div>

<div id="outline-container-sec-4-1-4" class="outline-4">
<h4 id="sec-4-1-4"><span class="section-number-4">4.1.4</span> Внесение заметок к вакансиям</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
Пользователь вносит свои соображения и заметки связанные с вакансией, или
фирмой-работодателем
</p>
</div>
</div>

<div id="outline-container-sec-4-1-5" class="outline-4">
<h4 id="sec-4-1-5"><span class="section-number-4">4.1.5</span> Заполнение резюме</h4>
<div class="outline-text-4" id="text-4-1-5">
<p>
Пользователь заполняет резюме
</p>
</div>
</div>

<div id="outline-container-sec-4-1-6" class="outline-4">
<h4 id="sec-4-1-6"><span class="section-number-4">4.1.6</span> Написание сопроводительных писем</h4>
<div class="outline-text-4" id="text-4-1-6">
<p>
Пользователь пишет шаблоны сопроводительных писем, которые будут отправлены вместе с
отзывом на вакансию
</p>
</div>
</div>

<div id="outline-container-sec-4-1-7" class="outline-4">
<h4 id="sec-4-1-7"><span class="section-number-4">4.1.7</span> Отправка отзывов</h4>
<div class="outline-text-4" id="text-4-1-7">
<p>
Пользователь отправляет отзыв на вакансию.
</p>



<p>
Основные этапы:
</p>
<ul class="org-ul">
<li>Регистрация/логин (цель - войти на сайт)
</li>
<li>Заполнение профиля (цель - определить поисковые запросы)
</li>
<li>Написание резюме (несколько резюме, возможно под каждую особо-интересную вакансию)
</li>
<li>Написание сопроводительных писем (тоже несколько, под вакансии)
</li>
<li>Сбор тизеров по поисковому запросу
</li>
<li>Ранжирование тизеров (положительный/отрицательный отсев)
</li>
<li>Таггирование тизеров
</li>
<li>Написание автоматических скриптов ранжирования по тегам (для продвинутых)
</li>
<li>Сбор заинтересовавших вакансий (выше чем определенный ранг)
</li>
<li>Ранжирование вакансий (положительный/отрицательный отсев)
</li>
<li>Связывание с резюме и сопроводительными письмами
</li>
<li>Отправка отзывов
</li>
<li>Внесение заметок
</li>
<li>Остальные переводы статуса и действия
</li>
</ul>

<p>
Зарегистрированный пользователь создает "поисковый профиль", в который заносит поисковый
запрос и (в будущем) источники данных. Поля профиля описаны в секции <a href="#sec-4-2">4.2</a>.
</p>

<p>
Потом он запрашивает сбор данных по этому поисковому профилю. Собираются тизеры
вакансий. Если появились новые вакансии они добавляются в набор. Изменившиеся вакансии
обновляются и помечаются как обновившиеся, не изменившиеся - не попадают в набор.
</p>

<p>
После сбора данных пользователь просматривает набор и фильтрует его, отсеивая неинтересные
вакансии, (которые скрываются) и помечая особенно понравившиеся (звездочкой).
</p>

<p>
После фильтрации у отобранных вакансий скачиваются описания
</p>

<p>
Выбрав вакансию, пользователь может оставить к ней заметки и начинает движение по графу состояний.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Поисковые профили</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Разумеется, лучше собирать не все подряд, а только то что необходимо соискателю. Когда
соискатель пользуется профильным сайтом он использует поисковые запросы, на основании
которых мы можем формировать, гм&#x2026; назовем это <code>поисковыми профилями</code>. Поисковый
профиль - это запрос пользователя, плюс набор связанных с ним вакансий=.
</p>

<p>
Вакансии на сайтах размещаются <code>компаниями</code> и привязываются к ним. Мне, как соискателю,
интересно посмотреть какие вакансии размещала ранее конкретная компания, какие она
размещает теперь, как изменялись зарплаты - и тому подобная аналитическая информация.
</p>

<p>
Загрузка данных начинается с автоматического использования поиска. Мне интересны разные
поисковые запросы - например, "веб-программист", "менеджер проекта", "руководитель
отдела" и.т.п. По каждому из них можно составить поисковый профиль, который кроме текущих
актуальных вакансий в нем содержит еще и "сборки" - с датой и временем получения данных и
"изменения", т.е диффы между предыдущей сборкой и этой. Таким образом, например, можно
отслеживать только что появляющиеся вакансии, которые часто представляют наибольший
интерес.
</p>

<p>
Мне бы хотелось осуществлять <code>сбор данных в многопоточном режиме</code>.
</p>
</div>

<div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> Список поисковых профилей</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Чтобы управлять поисковыми профилями нам понадобится страничка на которой их можно
создать, удалить и просмотреть.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">define-iface-add-del-entity</span> all-profiles <span style="color: #8b2252;">"/profiles"</span>
  <span style="color: #8b2252;">"&#1055;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1099;&#1077; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1080;"</span>
  <span style="color: #8b2252;">"&#1053;&#1086;&#1074;&#1099;&#1081; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;"</span>
  <span style="color: #8b2252;">"&#1050;&#1086;&#1075;&#1076;&#1072; &#1089;&#1086;&#1080;&#1089;&#1082;&#1072;&#1090;&#1077;&#1083;&#1100; &#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1077;&#1090;&#1089;&#1103; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100;&#1085;&#1099;&#1084; &#1089;&#1072;&#1081;&#1090;&#1086;&#1084; &#1086;&#1085; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1077;&#1090;</span>
<span style="color: #8b2252;">   &#1087;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1099;&#1077; &#1079;&#1072;&#1087;&#1088;&#1086;&#1089;&#1099;, &#1085;&#1072; &#1086;&#1089;&#1085;&#1086;&#1074;&#1072;&#1085;&#1080;&#1080; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1093; &#1084;&#1099; &#1084;&#1086;&#1078;&#1077;&#1084; &#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100;,</span>
<span style="color: #8b2252;">   &#1075;&#1084;... &#1085;&#1072;&#1079;&#1086;&#1074;&#1077;&#1084; &#1101;&#1090;&#1086; =&#1087;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1099;&#1084;&#1080; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1103;&#1084;&#1080;=. &#1055;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1099;&#1081; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100; - &#1101;&#1090;&#1086;</span>
<span style="color: #8b2252;">   &#1079;&#1072;&#1087;&#1088;&#1086;&#1089; &#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1077;&#1083;&#1103;, &#1087;&#1083;&#1102;&#1089; &#1085;&#1072;&#1073;&#1086;&#1088; &#1089;&#1074;&#1103;&#1079;&#1072;&#1085;&#1085;&#1099;&#1093; &#1089; &#1085;&#1080;&#1084; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;"</span>
   #'all-profile <span style="color: #8b2252;">"profile"</span>
  (name)
  (frm
   (tbl
    (list
     (row <span style="color: #8b2252;">"&#1053;&#1072;&#1079;&#1074;&#1072;&#1085;&#1080;&#1077;"</span> (fld <span style="color: #8b2252;">"name"</span>))
     (row <span style="color: #8b2252;">"&#1047;&#1072;&#1087;&#1088;&#1086;&#1089;"</span> (fld <span style="color: #8b2252;">"search"</span>))
     (row <span style="color: #8b2252;">""</span> %new%))))
  (<span style="color: #483d8b;">:new</span> (act-btn <span style="color: #8b2252;">"NEW"</span> <span style="color: #8b2252;">""</span> <span style="color: #8b2252;">"&#1057;&#1086;&#1079;&#1076;&#1072;&#1090;&#1100;"</span>)
        (<span style="color: #a020f0;">progn</span>
          (make-profile <span style="color: #483d8b;">:name</span> (getf p <span style="color: #483d8b;">:name</span>)
                        <span style="color: #483d8b;">:user-id</span> 1
                        <span style="color: #483d8b;">:search-query</span> (getf p <span style="color: #483d8b;">:search</span>)
                        <span style="color: #483d8b;">:ts-create</span> (get-universal-time)
                        <span style="color: #483d8b;">:ts-last</span> (get-universal-time))
          <span style="color: #8b2252;">"&#1055;&#1088;&#1086;&#1092;&#1080;&#1083;&#1100; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;"</span>))
  (<span style="color: #483d8b;">:del</span> (act-btn <span style="color: #8b2252;">"DEL"</span> (id i) <span style="color: #8b2252;">"&#1059;&#1076;&#1072;&#1083;&#1080;&#1090;&#1100;"</span>)
        (<span style="color: #a020f0;">progn</span>
          (del-profile (getf p <span style="color: #483d8b;">:data</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> Страничка поискового профиля</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
На страничке поискового профиля мы выводим все собранные по этому поисковому профилю
вакансии. Будем считать что нас не особо интересуют вакансии без указания зарплаты,
поэтому мы их просто отфильтровываем. После фильтрации сортируем в направлении уменьшения
зарплаты.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">vacancy-table</span> (raw)
  (<span style="color: #a020f0;">let</span> ((vacs (sort (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                   (equal 0 (salary x)))
                               raw)
                    #'(<span style="color: #a020f0;">lambda</span> (a b)
                        (&gt; (salary a) (salary b))))))
    (format nil <span style="color: #8b2252;">"&lt;h2&gt;&#1042;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;: ~A&lt;/h2&gt;~%~A"</span> (length vacs)
            (tbl
             (<span style="color: #a020f0;">with-collection</span> (vac vacs)
               (tr
                (td
                 (state vac))
                (td
                 (format nil <span style="color: #8b2252;">"&lt;div style=\"background-color:green\"&gt;~A&lt;/div&gt;"</span>
                         (input <span style="color: #8b2252;">"radio"</span> <span style="color: #483d8b;">:name</span> (format nil <span style="color: #8b2252;">"R~A"</span> (id vac)) <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"y"</span>
                                <span style="color: #483d8b;">:other</span> (<span style="color: #a020f0;">if</span> (string= <span style="color: #8b2252;">":INTERESTED"</span> (state vac)) <span style="color: #8b2252;">"checked=\"checked\""</span> <span style="color: #8b2252;">""</span>))))
                (td
                 (format nil <span style="color: #8b2252;">"&lt;div style=\"background-color:red\"&gt;~A&lt;/div&gt;"</span>
                         (input <span style="color: #8b2252;">"radio"</span> <span style="color: #483d8b;">:name</span> (format nil <span style="color: #8b2252;">"R~A"</span> (id vac)) <span style="color: #483d8b;">:value</span> <span style="color: #8b2252;">"n"</span>
                                <span style="color: #483d8b;">:other</span> (<span style="color: #a020f0;">if</span> (string= <span style="color: #8b2252;">":NOT_INTERESTED"</span> (state vac)) <span style="color: #8b2252;">"checked=\"checked\""</span> <span style="color: #8b2252;">""</span>))))
                (td (format nil <span style="color: #8b2252;">"&lt;a href=\"/vacancy/~A\"&gt;~A&lt;/a&gt;"</span> (id vac) (name vac)))
                (td (salary-text vac))
                (td (currency vac))))
             <span style="color: #483d8b;">:border</span> 1))))

(<span style="color: #a020f0;">define-page</span> profile <span style="color: #8b2252;">"/profile/:userid"</span>
  (<span style="color: #a020f0;">let*</span> ((i (parse-integer userid))
         (page-id (parse-integer userid))
         (u (get-profile i))
         (vacs (sort (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                    (equal 0 (salary x)))
                                (find-vacancy <span style="color: #483d8b;">:profile-id</span> page-id))
                     #'(<span style="color: #a020f0;">lambda</span> (a b)
                         (&gt; (salary a) (salary b))))))
    (<span style="color: #a020f0;">if</span> (null u)
        <span style="color: #8b2252;">"&#1053;&#1077;&#1090; &#1090;&#1072;&#1082;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1103;"</span>
        (format nil <span style="color: #8b2252;">"~{~A~}"</span>
                (list
                 <span style="color: #8b2252;">"&lt;script&gt;</span>
<span style="color: #8b2252;">                         function test (param) {</span>
<span style="color: #8b2252;">                            $.post(</span>
<span style="color: #8b2252;">                               \"/profile/1\",</span>
<span style="color: #8b2252;">                               {act: param},</span>
<span style="color: #8b2252;">                               function(data) {</span>
<span style="color: #8b2252;">                                  $(\"#dvtest\").html(data);</span>
<span style="color: #8b2252;">                               }</span>
<span style="color: #8b2252;">                           );</span>
<span style="color: #8b2252;">                         };</span>
<span style="color: #8b2252;">                  &lt;/script&gt;"</span>
                 (format nil <span style="color: #8b2252;">"&lt;h1&gt;&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1087;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1103; ~A&lt;/h1&gt;"</span> (id u))
                 (format nil <span style="color: #8b2252;">"&lt;h2&gt;&#1044;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1103; ~A&lt;/h2&gt;"</span> (name u))
                 (frm
                  (tbl
                   (<span style="color: #a020f0;">with-element</span> (u u)
                     (row <span style="color: #8b2252;">"&#1048;&#1084;&#1103; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1103;"</span> (fld <span style="color: #8b2252;">"name"</span> (name u)))
                     (row <span style="color: #8b2252;">"&#1047;&#1072;&#1087;&#1088;&#1086;&#1089;"</span> (fld <span style="color: #8b2252;">"search"</span> (search-query u)))
                     (row (hid <span style="color: #8b2252;">"profile_id"</span> (id u)) %change%))
                   <span style="color: #483d8b;">:border</span> 1))
                 (tbl
                  (tr
                   (td %show-all%)
                   (td %show-interests%)
                   (td %show-not-interests%)
                   (td %show-other%)))
                 (frm %proceess-interests%)
                 (frm
                  (list
                   <span style="color: #8b2252;">"&lt;br /&gt;&lt;br /&gt;"</span>
                   %clarify%
                   <span style="color: #8b2252;">"&lt;div id=\"dvtest\"&gt;dvtest&lt;/div&gt;"</span>))))))
  (<span style="color: #483d8b;">:change</span>  (act-btn <span style="color: #8b2252;">"CHANGE"</span> <span style="color: #8b2252;">""</span> <span style="color: #8b2252;">"&#1048;&#1079;&#1084;&#1077;&#1085;&#1080;&#1090;&#1100;"</span>)
            (id (upd-profile (get-profile (parse-integer userid))
                             (list <span style="color: #483d8b;">:name</span> (getf p <span style="color: #483d8b;">:name</span>) <span style="color: #483d8b;">:search-query</span> (getf p <span style="color: #483d8b;">:query</span>)))))
  (<span style="color: #483d8b;">:clarify</span> (act-btn <span style="color: #8b2252;">"CLARIFY"</span> <span style="color: #8b2252;">""</span> <span style="color: #8b2252;">"&#1059;&#1090;&#1086;&#1095;&#1085;&#1080;&#1090;&#1100;"</span>)
            (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> key <span style="color: #483d8b;">:in</span> (cddddr p) <span style="color: #483d8b;">:by</span> #'cddr <span style="color: #483d8b;">:collect</span>
               (<span style="color: #a020f0;">let*</span> ((val (getf p key))
                      (id  (parse-integer (subseq (symbol-name key) 1)))
                      (vac (get-vacancy id)))
                 (list id
                       (<span style="color: #a020f0;">cond</span> ((string= <span style="color: #8b2252;">"y"</span> val)
                              (<span style="color: #a020f0;">unless</span> (string= <span style="color: #8b2252;">":INTERESTED"</span> (state vac))
                                (takt vac <span style="color: #483d8b;">:interested</span>)))
                             ((string= <span style="color: #8b2252;">"n"</span> val)
                              (<span style="color: #a020f0;">unless</span> (string= <span style="color: #8b2252;">":NOT_INTERESTED"</span> (state vac))
                                (takt vac <span style="color: #483d8b;">:not_interested</span>)))
                             (t <span style="color: #8b2252;">"err param"</span>))))))
  (<span style="color: #483d8b;">:show-all</span> (format nil <span style="color: #8b2252;">"&lt;input type=\"button\" onclick=\"test('SHOW-ALL');\" value=\"&#1074;&#1089;&#1077;\"&gt;"</span>)
             (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> (vacancy-table (find-vacancy <span style="color: #483d8b;">:profile-id</span> 1))))
  (<span style="color: #483d8b;">:show-interests</span> (format nil <span style="color: #8b2252;">"&lt;input type=\"button\" onclick=\"test('SHOW-INTERESTS');\" value=\"&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;\"&gt;"</span>)
                   (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> (vacancy-table (find-vacancy <span style="color: #483d8b;">:state</span> <span style="color: #8b2252;">":INTERESTED"</span> <span style="color: #483d8b;">:profile-id</span> 1))))
  (<span style="color: #483d8b;">:show-not-interests</span> (format nil <span style="color: #8b2252;">"&lt;input type=\"button\" onclick=\"test('SHOW-NOT-INTERESTS');\" value=\"&#1085;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;\"&gt;"</span>)
                       (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> (vacancy-table (find-vacancy <span style="color: #483d8b;">:state</span> <span style="color: #8b2252;">":NOT_INTERESTED"</span> <span style="color: #483d8b;">:profile-id</span> 1))))
  (<span style="color: #483d8b;">:show-other</span> (format nil <span style="color: #8b2252;">"&lt;input type=\"button\" onclick=\"test('SHOW-OTHER');\" value=\"&#1086;&#1089;&#1090;&#1072;&#1083;&#1100;&#1085;&#1099;&#1077;\"&gt;"</span>)
               (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> (vacancy-table (remove-if #'(<span style="color: #a020f0;">lambda</span> (x)
                                                                  (or (string= <span style="color: #8b2252;">":NOT_INTERESTED"</span> (state x) )
                                                                      (string= <span style="color: #8b2252;">":INTERESTED"</span> (state x))))
                                                              (find-vacancy <span style="color: #483d8b;">:profile-id</span> 1)))))
  (<span style="color: #483d8b;">:proceess-interests</span> (act-btn <span style="color: #8b2252;">"PROCEESS-INTERESTS"</span> <span style="color: #8b2252;">""</span> <span style="color: #8b2252;">"&#1057;&#1086;&#1073;&#1088;&#1072;&#1090;&#1100; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1093; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;"</span>)
                       <span style="color: #8b2252;">"TODO"</span>))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(profile-id (car (all-vacancy)))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(mapcar #'(lambda (x)</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">(salary x))</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(find-vacancy :profile-id 1))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(car</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(remove-if #'(lambda (x)</span>
<span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(null (getf x :salary)))</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">*teasers*))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(currency</span>
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">(car</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(remove-if #'(lambda (x)</span>
<span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(equal (salary x) 0))</span>
<span style="color: #b22222;">;;              </span><span style="color: #b22222;">(all-vacancy))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Поиск вакансий</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Внутри вакансий необходимо искать по критериям, которые я уточню позже
</p>

<p>
Мне хотелось бы чтобы вакансии были упорядочены по зарплате
</p>

<p>
Мне бы хотелось сразу получать представление, насколько свежая вакансия
</p>

<p>
Мне было бы интересно, сколько интервью было проведено и запланировано по вакансии - эту
информацию можно узнать из анализа активности по ней других пользователей
</p>

<p>
Мне было бы интересно, как менялась вакансия с момента ее размещения компанией - можно
находить и отслеживать похожие вакансии по расстоянию Левенштейна в описании, к
примеру. Динамика изменения зарплатного предложения может многое сказать об отношении к
вакансии.
</p>
</div>
</div>

<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> Ручной отбор вакансий</h3>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Автоматический отбор вакансий</h3>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> Внесение заметок по вакансии</h3>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> Просмотр и отбор вакансий, заметки и выставление статусов</h3>
<div class="outline-text-3" id="text-4-7">
<p>
Когда я читаю вакансию, я бы хотел, чтобы она переходила в статус "просмотрено" (и к ней
добавлялась дата просмотра)
</p>

<p>
Читая вакансию, мне бы хотелось устанавливать ей приоритет и вносить заметки, чтобы
отслеживать такие моменты, как например: необходимость позвонить позже, или все, что мне
сказал hr по телефону. Есть типовые вещи, которые можно просто сделать кнопками.
</p>

<p>
Если я отправляю отзыв на вакансию или звоню по телефону - я бы хотел, чтобы эти действия
сопровождались временем и изменением статуса, чтобы потом можно было отследить историю
взаимодействия с фирмой.
</p>

<p>
При этом, мне хотелось бы видеть на дашборде те вакансии, с которыми я договорился о
встрече и те, по которым нет движения долгое время, чтобы ничего не забывалось.
</p>
</div>
</div>

<div id="outline-container-sec-4-8" class="outline-3">
<h3 id="sec-4-8"><span class="section-number-3">4.8</span> Дашборд</h3>
<div class="outline-text-3" id="text-4-8">
<p>
Если у нас есть формализованный алгоритм (а он есть, так как найм - это линейный
процесс), то я хочу получать напоминания о моем следующем шаге в отношении тех вакансий,
которые мне интересны.
</p>

<p>
Мне бы хотелось видеть на каком я этапе в тех вакансиях, которые меня интересуют.
</p>
</div>
</div>

<div id="outline-container-sec-4-9" class="outline-3">
<h3 id="sec-4-9"><span class="section-number-3">4.9</span> Отзывы соискателей о компаниях и вакансиях</h3>
<div class="outline-text-3" id="text-4-9">
<p>
Можно сэкономить кучу времени и денег просто не нанимаясь в те компании, в которых "все
плохо". В этом плане соискатели могут помоч друг другу. Возможно и компании тоже будут
прислушиваться к такому фидбеку
</p>
</div>
</div>

<div id="outline-container-sec-4-10" class="outline-3">
<h3 id="sec-4-10"><span class="section-number-3">4.10</span> Размещение резюме</h3>
<div class="outline-text-3" id="text-4-10">
<p>
Пользователь просто размещает свое резюме. На самом деле - несколько резюме, так как
наиболее продвинутые пользователи пишут резюме под вакансию, а не рассылают одно и то же
резюме всем подряд
</p>
</div>
</div>

<div id="outline-container-sec-4-11" class="outline-3">
<h3 id="sec-4-11"><span class="section-number-3">4.11</span> Маршрут</h3>
<div class="outline-text-3" id="text-4-11">
<p>
Иногда я хочу спланировать маршрут поездки по собеседованиям. Это сервис с картами,
которые можно сделать позже.
</p>
</div>
</div>

<div id="outline-container-sec-4-12" class="outline-3">
<h3 id="sec-4-12"><span class="section-number-3">4.12</span> Создание вакансии работодателем</h3>
</div>
<div id="outline-container-sec-4-13" class="outline-3">
<h3 id="sec-4-13"><span class="section-number-3">4.13</span> Вакансия становится неактуальной</h3>
<div class="outline-text-3" id="text-4-13">
<p>
Вакансия может стать неактуальной если работодатель снимет ее, но работодатели могут
забывать это сделать, поэтому можно предусмотреть тайм-аут или даже некоторое кол-во
голосов соискателей, которые дозвонились но им сказали, что вакансия уже неактуальна.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Сущности</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Поисковые профили</h3>
<div class="outline-text-3" id="text-5-1">
<table id="profile_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Данные поискового профиля</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">user-id</td>
<td class="left">integer</td>
<td class="left">владелец и создатель</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название профиля</td>
</tr>

<tr>
<td class="left">search-query</td>
<td class="left">varchar</td>
<td class="left">поисковый запрос</td>
</tr>

<tr>
<td class="left">ts-create</td>
<td class="left">bigint</td>
<td class="left">время создания</td>
</tr>

<tr>
<td class="left">ts-last</td>
<td class="left">bigint</td>
<td class="left">время когда был использован последний раз</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Вакансии</h3>
<div class="outline-text-3" id="text-5-2">
<table id="vacancy_flds" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Данные вакансии</caption>

<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">field name</th>
<th scope="col" class="left">field type</th>
<th scope="col" class="left">note</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">идентификатор</td>
</tr>

<tr>
<td class="left">profile-id</td>
<td class="left">integer</td>
<td class="left">идентификатор поискового профиля</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">varchar</td>
<td class="left">название вакансии</td>
</tr>

<tr>
<td class="left">rem-id</td>
<td class="left">integer</td>
<td class="left">идентификатор вакансии на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">rem-date</td>
<td class="left">varchar</td>
<td class="left">дата создания вакансии на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">rem-employer-name</td>
<td class="left">varchar</td>
<td class="left">имя работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">rem-employer-id</td>
<td class="left">(or db-null integer)</td>
<td class="left">идентификатор работодателя на удаленном ресурсе</td>
</tr>

<tr>
<td class="left">currency</td>
<td class="left">(or db-null varchar)</td>
<td class="left">валюта зарплаты</td>
</tr>

<tr>
<td class="left">salary</td>
<td class="left">(or db-null integer)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">salary-text</td>
<td class="left">(or db-null varchar)</td>
<td class="left">размер компенсации</td>
</tr>

<tr>
<td class="left">contact</td>
<td class="left">(or db-null varchar)</td>
<td class="left">телефон контактного лица</td>
</tr>

<tr>
<td class="left">text</td>
<td class="left">(or db-null varchar)</td>
<td class="left">описание вакансии</td>
</tr>

<tr>
<td class="left">history</td>
<td class="left">(or db-null varchar)</td>
<td class="left">список изменения статусов со временем каждого изменения</td>
</tr>

<tr>
<td class="left">reason</td>
<td class="left">(or db-null varchar)</td>
<td class="left">добавляем причину действия (позже ссылка на другую таблицу)</td>
</tr>

<tr>
<td class="left">ts-created</td>
<td class="left">(or db-null bigint)</td>
<td class="left">время создания вакансии</td>
</tr>

<tr>
<td class="left">ts-viewed</td>
<td class="left">(or db-null bigint)</td>
<td class="left">время когда вакансия была просмотрена</td>
</tr>
</tbody>
</table>


<p>
Вакансии могут появляться у нас следующими путями:
</p>
<ul class="org-ul">
<li>Работодатель может создать вакансию
</li>
<li>Мы можем получить вакансию анализируя другой сайт
</li>
</ul>

<p>
В случае, если мы получаем вакансию анализируя другой сайт, мы получаем ее в 2 этапа. На
первом этапе мы разобрали т.н. "тизер вакансии" и занесли ее в базу данных в состоянии
<code>teaser</code>, чтобы потом получить все остальные данные. На втором этапе мы получаем данные
со страницы вакансии и устанавливаем состояние <code>new</code>.
</p>

<p>
Если пользователю не нравится тизер и он решает скрыть вакансию - она сразу из состояния
<code>teaser</code> попадает в состояние <code>not_interested</code>.
</p>

<p>
Если же пользователю наоборот, нравится вакансия, она из состояния <code>teaser</code> попадает в
состояние <code>interested</code>.
</p>

<p>
Когда вакансия переносится в архив - мы должны отслеживать это на стороннем сайте и
реагировать, устанавливая статус <code>archive</code>
</p>

<p>
TODO: Конечный автомат тут сложен и будет еще уточняться&#x2026; Пока состояния такие:
 <code>просмотрено</code> (с датой), <code>отобрано</code>, <code>не-берут-трубку</code>, <code>не-актуально</code>,
 <code>приглашен-на-интервью</code>, <code>тестовое-задание</code>, <code>получен-оффер</code>, <code>отказано-работодателем</code>,
 <code>отказ-соискателя</code>, <code>вакансия-снята</code> итп.
</p>

<p>
Когда мы собираем вакансии, распарсивая их с других сайтов, мы должны отслеживать их
состояние на этих сайтах. Мы узнаем о вакансии, ко
</p>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Перекрестные связи с другими вакансиями</h3>
<div class="outline-text-3" id="text-5-3">
<p>
В ряде случаев компании меняют свои вакансии, некоторые делают это методом удаления
предыдущей и создания новой. Мне как соискателю хотелось бы не обнаруживать уже
просмотренную и возможно собеседованную вакансию в новых. Поэтому хотелось бы
предусмотреть механизм, который связывает очень похожие вакансии друг с другом.
</p>

<p>
Иногда вакансии меняются, или в них меняются существенные условия. Например, две недели
назад, когда я смотрел вакансию из предыдущей сборки меня не устроила зарпалата, а
сегодня вакансия стала интереснее. Я хочу отслеживать что вакансия поменялась.
</p>

<p>
Таким образом при создании вакансии мы должны проверять, может она уже есть в базе и
тогда указывать, что эта вакансия включена в несколько сборок (требует таблицы связи)
</p>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> Компании</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Несколько вакансий могут быть от одной компании. В этом случае мне бы хотелось
отслеживать это в профиле компании, кроме того интересна аналитика по этой компании за
определенный период времени.
</p>

<p>
С социальной точки зрения интересно получать отзывы о компании от ее работников, в том
числе и уволенных.
</p>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Действия по вакансии: звонки, скайп-интервью, собеседования</h3>
<div class="outline-text-3" id="text-5-5">
<p>
В эту таблицу заносим что сделано по каждой вакансии, которая находится в разработке
</p>
</div>
</div>

<div id="outline-container-sec-5-6" class="outline-3">
<h3 id="sec-5-6"><span class="section-number-3">5.6</span> Теги вакансий</h3>
<div class="outline-text-3" id="text-5-6">
<p>
Помогают ориентироваться, когда вакансий много.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Interface</h2>
<div class="outline-text-2" id="text-6">
<p>
Соберем веб-интерфейс:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface"><span style="color: #b22222;">;;;; </span><span style="color: #b22222;">iface.lisp</span>

(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;</span>
&lt;&lt;iface_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Главная страница модуля</h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(restas:define-route hh-main (<span style="color: #8b2252;">"/hh"</span>)
  (<span style="color: #a020f0;">with-wrapper</span>
      <span style="color: #8b2252;">"&lt;h1&gt;&#1043;&#1083;&#1072;&#1074;&#1085;&#1072;&#1103; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; HH&lt;/h1&gt;"</span>
    ))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Галлерея (parenscript)</h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*slideshows*</span> (make-hash-table <span style="color: #483d8b;">:test</span> 'equalp))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">add-slideshow</span> (slideshow-name image-folder)
  (setf (gethash slideshow-name *slideshows*)
        (mapcar (<span style="color: #a020f0;">lambda</span> (pathname)
                  (url-encode (format nil <span style="color: #8b2252;">"~a.~a"</span>
                                      (pathname-name pathname)
                                      (pathname-type pathname))))
                (list-directory image-folder))))

(add-slideshow <span style="color: #8b2252;">"img"</span> <span style="color: #8b2252;">"/home/rigidus/repo/moto/img/"</span>)
(add-slideshow <span style="color: #8b2252;">"pic"</span> <span style="color: #8b2252;">"/home/rigidus/repo/moto/pic/"</span>)

(alexandria:hash-table-plist *slideshows*)

(defmacro/ps slideshow-image-uri (slideshow-name image-file)
  `(concatenate 'string ,slideshow-name <span style="color: #8b2252;">"/"</span> ,image-file))

(restas:define-route y (<span style="color: #8b2252;">"y"</span>)
  (ps
    (<span style="color: #a020f0;">define-symbol-macro</span> <span style="color: #0000ff;">fragment-identifier</span> (@ window location hash))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">show-image-number</span> (image-index)
      (<span style="color: #a020f0;">let</span> ((image-name (aref *images* (setf *current-image-index* image-index))))
        (setf (chain document (get-element-by-id <span style="color: #8b2252;">"slideshow-img-object"</span>) src)
              (slideshow-image-uri *slideshow-name* image-name)
              fragment-identifier
              image-name)))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">previous-image</span> ()
      (<span style="color: #a020f0;">when</span> (&gt; *current-image-index* 0)
        (show-image-number (1- *current-image-index*))))
    (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">next-image</span> ()
      (<span style="color: #a020f0;">when</span> (&lt; *current-image-index* (1- (getprop *images* 'length)))
        (show-image-number (1+ *current-image-index*))))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">this gives bookmarkability using fragment identifiers</span>
    (setf (getprop window 'onload)
          (<span style="color: #a020f0;">lambda</span> ()
            (<span style="color: #a020f0;">when</span> fragment-identifier
              (<span style="color: #a020f0;">let</span> ((image-name (chain fragment-identifier (slice 1))))
                (<span style="color: #a020f0;">dotimes</span> (i (length *images*))
                  (<span style="color: #a020f0;">when</span> (string= image-name (aref *images* i))
                    (show-image-number i)))))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slideshow-handler</span> (slideshow-name)
  (<span style="color: #a020f0;">let*</span> ((images (gethash slideshow-name *slideshows*))
         (current-image-index (or (position (get-parameter <span style="color: #8b2252;">"image"</span>) images <span style="color: #483d8b;">:test</span> #'equalp)
                                  0))
         (previous-image-index (max 0 (1- current-image-index)))
         (next-image-index (min (1- (length images)) (1+ current-image-index))))
    (<span style="color: #a020f0;">with-html-output-to-string</span> (s)
      (<span style="color: #483d8b;">:html</span>
       (<span style="color: #483d8b;">:head</span>
        (<span style="color: #483d8b;">:title</span> <span style="color: #8b2252;">"Parenscript slideshow"</span>)
        (<span style="color: #483d8b;">:script</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"text/javascript"</span>
                 (str (ps* `(<span style="color: #a020f0;">progn</span>
                              (var *slideshow-name* ,slideshow-name)
                              (var *images* (array ,@images))
                              (var *current-image-index* ,current-image-index)))))
        (<span style="color: #483d8b;">:script</span> <span style="color: #483d8b;">:type</span> <span style="color: #8b2252;">"text/javascript"</span> <span style="color: #483d8b;">:src</span> <span style="color: #8b2252;">"/y"</span>)
        )
       (<span style="color: #483d8b;">:body</span>
        (<span style="color: #483d8b;">:div</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"slideshow-container"</span>
              <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"width:100%;text-align:center"</span>
              (<span style="color: #483d8b;">:img</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"slideshow-img-object"</span>
                    <span style="color: #483d8b;">:src</span> (slideshow-image-uri slideshow-name
                                              (elt images current-image-index)))
              <span style="color: #483d8b;">:br</span>
              (<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"?image=~a"</span> (elt images previous-image-index))
                  <span style="color: #483d8b;">:onclick</span> (ps (previous-image) (<span style="color: #a020f0;">return</span> false))
                  <span style="color: #8b2252;">"Previous"</span>)
              <span style="color: #8b2252;">" "</span>
              (<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:href</span> (format nil <span style="color: #8b2252;">"?image=~a"</span> (elt images next-image-index))
                  <span style="color: #483d8b;">:onclick</span> (ps (next-image) (<span style="color: #a020f0;">return</span> false))
                  <span style="color: #8b2252;">"Next"</span>)
              ))))))

(restas:define-route x (<span style="color: #8b2252;">"/x"</span>)
  (slideshow-handler <span style="color: #8b2252;">"pic"</span>))

(restas:define-route z (<span style="color: #8b2252;">"/z"</span>)
  (slideshow-handler <span style="color: #8b2252;">"img"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Список вакансий</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Мне бы хотелось иметь интерфейс для того чтобы управлять собранными элементами - в первую
очередь ранжировать их по интересности. Для этого, мне нужно уметь перемещать эти
элементы в коллекции.
</p>

<p>
Но перед этим мне нужно сделать отображение этих элементов через ajax
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="iface_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(defmacro/ps s+ (<span style="color: #228b22;">&amp;body</span> body)
  `(concatenate 'string ,@body))

(defmacro/ps btn+ (name value onclick)
  `(s+ <span style="color: #8b2252;">"&lt;input type='button' name='"</span> ,name
       <span style="color: #8b2252;">"' value='"</span> ,value
       <span style="color: #8b2252;">"' onclick='"</span> ,onclick
       <span style="color: #8b2252;">";return false;' /&gt;"</span>))

(defmacro/ps asm+ (id name salary-text)
  `(s+ <span style="color: #8b2252;">"&lt;li id=\""</span> ,id <span style="color: #8b2252;">"\"&gt;"</span>
       <span style="color: #8b2252;">"&lt;span class=\"handle\"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&amp;nbsp;&amp;nbsp;"</span>
       ,name
       <span style="color: #8b2252;">"&amp;nbsp;"</span>
       <span style="color: #8b2252;">"&lt;span style='color: red'&gt;"</span> ,salary-text <span style="color: #8b2252;">"&lt;/span&gt;"</span>
       <span style="color: #8b2252;">"&lt;/li&gt;"</span>))

(restas:define-route collection (<span style="color: #8b2252;">"/collection"</span>)
  (<span style="color: #a020f0;">labels</span> ((asm-node (x)
             (asm+ (format nil <span style="color: #8b2252;">"~A"</span> (id x))
                   (name x)
                   (<span style="color: #a020f0;">let</span> ((it (salary-text x)))
                     (<span style="color: #a020f0;">if</span> (equal it <span style="color: #8b2252;">"false"</span>) <span style="color: #8b2252;">""</span> it))))
           (mrg (param)
             (<span style="color: #a020f0;">if</span> (null param)
                 (ps-html ((<span style="color: #483d8b;">:li</span> <span style="color: #483d8b;">:id</span> 0)
                           <span style="color: #8b2252;">"&#1053;&#1077;&#1090; &#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1081;"</span>))
                 (reduce #'(<span style="color: #a020f0;">lambda</span> (x y)
                             (concatenate 'string x (string #\NewLine) y))
                         (mapcar #'(<span style="color: #a020f0;">lambda</span> (x)
                                     (asm-node x))
                                 param)))))
    (<span style="color: #a020f0;">let*</span> ((vacs (aif (find-vacancy <span style="color: #483d8b;">:profile-id</span> 1) it (err <span style="color: #8b2252;">"null vacancy"</span>)))
           (sorted-vacs (sort vacs #'(<span style="color: #a020f0;">lambda</span> (a b) (&gt; (salary a) (salary b)))))
           (not-interesting)
           (interesting)
           (unsort))
      (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> vac <span style="color: #483d8b;">:in</span> sorted-vacs <span style="color: #483d8b;">:do</span>
         (<span style="color: #a020f0;">if</span> (equal 0 (salary vac))
             (setf not-interesting (append not-interesting (list vac)))
             (<span style="color: #a020f0;">if</span> (or (search <span style="color: #8b2252;">"android"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">".net"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"python"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"javascript"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"&#1089;#"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"&#1089;++"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"ruby"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"SAP"</span> (name vac))
                     (search <span style="color: #8b2252;">"1&#1057;"</span> (name vac))
                     (search <span style="color: #8b2252;">"QA"</span> (name vac))
                     (search <span style="color: #8b2252;">"objective-c"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"ios"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"delphi"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"sharepoint"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"flash"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"windows"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"pl/sql"</span> (string-downcase (name vac)))
                     (search <span style="color: #8b2252;">"front-end"</span> (string-downcase (name vac)))
                     (and (equal <span style="color: #8b2252;">"RUR"</span> (currency vac))
                          (&gt; 50000 (salary vac)))
                     )
                 (setf not-interesting (append not-interesting (list vac)))
                 (<span style="color: #a020f0;">if</span> (or (search <span style="color: #8b2252;">"php"</span> (string-downcase (name vac)))
                         (search <span style="color: #8b2252;">"java"</span> (string-downcase (name vac)))
                         (search <span style="color: #8b2252;">"web"</span> (string-downcase (name vac)))
                         (search <span style="color: #8b2252;">"backend"</span> (string-downcase (name vac)))
                         (search <span style="color: #8b2252;">"back-end"</span> (string-downcase (name vac)))
                         )
                     (setf interesting (append interesting (list vac)))
                     <span style="color: #b22222;">;; </span><span style="color: #b22222;">(setf unsort (append unsort (list vac)))</span>
                     ))))
      (<span style="color: #a020f0;">with-wrapper</span>
        (ps-html
         ((<span style="color: #483d8b;">:link</span> <span style="color: #483d8b;">:href</span> <span style="color: #8b2252;">"/css/dnd.css"</span> <span style="color: #483d8b;">:rel</span> <span style="color: #8b2252;">"stylesheet"</span> <span style="color: #483d8b;">:media</span> <span style="color: #8b2252;">"all"</span>))
         ((<span style="color: #483d8b;">:script</span> <span style="color: #483d8b;">:src</span> <span style="color: #8b2252;">"/js/jquery.sortable.js"</span>))
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">(:script (ps</span>
         <span style="color: #b22222;">;;            </span><span style="color: #b22222;">(defun up (id)</span>
         <span style="color: #b22222;">;;              </span><span style="color: #b22222;">(let* ((obj ((@ $) (+ "#tr" id))))</span>
         <span style="color: #b22222;">;;                </span><span style="color: #b22222;">((@ obj after) ((@ obj prev)))))</span>
         <span style="color: #b22222;">;;            </span><span style="color: #b22222;">(defun down (id)</span>
         <span style="color: #b22222;">;;              </span><span style="color: #b22222;">(let* ((obj ((@ $) (+ "#tr" id))))</span>
         <span style="color: #b22222;">;;                </span><span style="color: #b22222;">((@ obj before) ((@ obj next)))))</span>
         <span style="color: #b22222;">;;            </span><span style="color: #b22222;">(defun asm-teaser (i id name state salary salary-text currency)</span>
         <span style="color: #b22222;">;;              </span><span style="color: #b22222;">(s+ "&lt;li id='tr" id "'&gt;"</span>
         <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(s+ "&lt;li&gt;" name "&lt;/td&gt;")</span>
         <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">"&lt;/li&gt;"))</span>
         <span style="color: #b22222;">;;            </span><span style="color: #b22222;">(defun load-elts (param)</span>
         <span style="color: #b22222;">;;              </span><span style="color: #b22222;">((@ $ post) "/collection" (create :act param)</span>
         <span style="color: #b22222;">;;               </span><span style="color: #b22222;">(lambda (data)</span>
         <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">((@ ((@ $) "#vacancy-container")  html) "")</span>
         <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">((@ $ each) data</span>
         <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(lambda (i data)</span>
         <span style="color: #b22222;">;;                    </span><span style="color: #b22222;">((@ ((@ $) "#vacancy-container")  append)</span>
         <span style="color: #b22222;">;;                     </span><span style="color: #b22222;">(asm-teaser i (@ data id) (@ data name) (@ data state)</span>
         <span style="color: #b22222;">;;                                 </span><span style="color: #b22222;">(@ data salary) (@ data salary-text) (@ data currency))))))</span>
         <span style="color: #b22222;">;;               </span><span style="color: #b22222;">:json))))</span>
         ((<span style="color: #483d8b;">:table</span> <span style="color: #483d8b;">:border</span> 0)
          ((<span style="color: #483d8b;">:tr</span>)
           ((<span style="color: #483d8b;">:td</span>)
            ((<span style="color: #483d8b;">:textarea</span> <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"code"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"code"</span> <span style="color: #483d8b;">:rows</span> 20 <span style="color: #483d8b;">:cols</span> 160)
             (ps
               (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">load-elts</span> (param)
                 ((@ $ post) <span style="color: #8b2252;">"/collection"</span> (create <span style="color: #483d8b;">:act</span> param)
                  (<span style="color: #a020f0;">lambda</span> (data)
                    ((@ ((@ $) <span style="color: #8b2252;">"#vacancy-container"</span>)  html) <span style="color: #8b2252;">""</span>)
                    ((@ $ each) data
                     (<span style="color: #a020f0;">lambda</span> (i data)
                       ((@ ((@ $) <span style="color: #8b2252;">"#vacancy-container"</span>)  append)
                        (s+ <span style="color: #8b2252;">"&lt;li id='"</span> (@ data id) <span style="color: #8b2252;">"'&gt;"</span> (@ data name) <span style="color: #8b2252;">"&lt;/li&gt;"</span>)))))
                  <span style="color: #483d8b;">:json</span>))
               (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">vac-hook</span> (vac)
                 <span style="color: #b22222;">;; </span><span style="color: #b22222;">(if (equal 0 (salary vac))</span>
                 <span style="color: #b22222;">;;     </span><span style="color: #b22222;">(setf not-interesting (append not-interesting (list vac)))</span>
                 <span style="color: #b22222;">;;     </span><span style="color: #b22222;">(if (or (search "android" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search ".net" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "python" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "javascript" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "&#1089;#" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "&#1089;++" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "ruby" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "SAP" (name vac))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "1&#1057;" (name vac))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "QA" (name vac))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "objective-c" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "ios" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "delphi" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "sharepoint" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "flash" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "windows" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "pl/sql" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(search "front-end" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(and (equal "RUR" (currency vac))</span>
                 <span style="color: #b22222;">;;                  </span><span style="color: #b22222;">(&gt; 50000 (salary vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">)</span>
                 <span style="color: #b22222;">;;         </span><span style="color: #b22222;">(setf not-interesting (append not-interesting (list vac)))</span>
                 <span style="color: #b22222;">;;         </span><span style="color: #b22222;">(if (or (search "php" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(search "java" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(search "web" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(search "backend" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">(search "back-end" (string-downcase (name vac)))</span>
                 <span style="color: #b22222;">;;                 </span><span style="color: #b22222;">)</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(setf interesting (append interesting (list vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">(setf unsort (append unsort (list vac)))</span>
                 <span style="color: #b22222;">;;             </span><span style="color: #b22222;">)))</span>
                 )
               (load-elts <span style="color: #8b2252;">"stub"</span>)
               )))
           ((<span style="color: #483d8b;">:td</span>)
            ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"loadElts(1); return false"</span>) <span style="color: #8b2252;">"loadElts(1);"</span>)
            (<span style="color: #483d8b;">:br</span>)
            ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"eval($('#code').val()); return false;"</span>) <span style="color: #8b2252;">"eval #code"</span>)
            (<span style="color: #483d8b;">:br</span>)
            ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"alert(getChildIds('#interesting-container')); return false;"</span>) <span style="color: #8b2252;">"childs"</span>)
            (<span style="color: #483d8b;">:br</span>)
            ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"$('.connected').sortable('destroy'); return false;"</span>) <span style="color: #8b2252;">"destroy"</span>)
            (<span style="color: #483d8b;">:br</span>)
            ((<span style="color: #483d8b;">:a</span> <span style="color: #483d8b;">:onclick</span> <span style="color: #8b2252;">"$('.connected').sortable({ connectWith: '.connected', handle: '.handle'}); return false;"</span>) <span style="color: #8b2252;">"make"</span>)
            (<span style="color: #483d8b;">:br</span>))))
         ((<span style="color: #483d8b;">:table</span> <span style="color: #483d8b;">:border</span> 0 <span style="color: #483d8b;">:style</span> <span style="color: #8b2252;">"font-size: small;"</span>)
          ((<span style="color: #483d8b;">:th</span>) <span style="color: #8b2252;">"&#1048;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;"</span>)
          ((<span style="color: #483d8b;">:th</span>) <span style="color: #8b2252;">"&#1053;&#1077;&#1088;&#1072;&#1079;&#1086;&#1073;&#1088;&#1072;&#1085;&#1085;&#1099;&#1077;"</span>)
          ((<span style="color: #483d8b;">:th</span>) <span style="color: #8b2252;">"&#1053;&#1077;&#1080;&#1085;&#1090;&#1077;&#1088;&#1077;&#1089;&#1085;&#1099;&#1077;"</span>)
          ((<span style="color: #483d8b;">:tr</span>)
           ((<span style="color: #483d8b;">:td</span> <span style="color: #483d8b;">:width</span> 500 <span style="color: #483d8b;">:valign</span> <span style="color: #8b2252;">"top"</span>)
            ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"interesting-container"</span>)
             (mrg interesting)))
           ((<span style="color: #483d8b;">:td</span> <span style="color: #483d8b;">:width</span> 500 <span style="color: #483d8b;">:valign</span> <span style="color: #8b2252;">"top"</span>)
            ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"unsort-container"</span>)
             (mrg unsort)))
           ((<span style="color: #483d8b;">:td</span> <span style="color: #483d8b;">:width</span> 500 <span style="color: #483d8b;">:valign</span> <span style="color: #8b2252;">"top"</span>)
            ((<span style="color: #483d8b;">:ul</span> <span style="color: #483d8b;">:class</span> <span style="color: #8b2252;">"connected"</span> <span style="color: #483d8b;">:id</span> <span style="color: #8b2252;">"not-interesting-container"</span>)
             (mrg not-interesting))))))))))



(restas:define-route collection-post (<span style="color: #8b2252;">"/collection"</span> <span style="color: #483d8b;">:method</span> <span style="color: #483d8b;">:post</span>)
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">TODO: &#1058;&#1091;&#1090; &#1087;&#1077;&#1088;&#1077;&#1076; &#1082;&#1086;&#1076;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1077;&#1084; &#1084;&#1086;&#1078;&#1085;&#1086; &#1091;&#1073;&#1080;&#1088;&#1072;&#1090;&#1100; &#1080;&#1079; &#1087;&#1077;&#1088;&#1077;&#1089;&#1099;&#1083;&#1072;&#1077;&#1084;&#1099;&#1093; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1083;&#1080;&#1096;&#1085;&#1080;&#1077; &#1087;&#1086;&#1083;&#1103;, &#1095;&#1090;&#1086;&#1073;&#1099; &#1085;&#1077; &#1089;&#1083;&#1072;&#1090;&#1100; &#1080;&#1093; &#1087;&#1086; &#1089;&#1077;&#1090;&#1080;</span>
  (<span style="color: #a020f0;">with-wrapper</span>
    (<span style="color: #ff0000; font-weight: bold;">error</span> 'ajax <span style="color: #483d8b;">:output</span> (cl-json:encode-json-to-string
                          (aif (find-vacancy <span style="color: #483d8b;">:profile-id</span> 1)
                               it
                               (err <span style="color: #8b2252;">"null vacancy"</span>))))))
</pre>
</div>

<p>
<a href="http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/">http://isocra.com/2008/02/table-drag-and-drop-jquery-plugin/</a>
<a href="http://romka.eu/blog/jquery-table-drag-and-drop">http://romka.eu/blog/jquery-table-drag-and-drop</a>
</p>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> Дашборд</h3>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Тесты</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-lisp" id="hh_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; hh</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">hh-test</span> ()
  &lt;&lt;hh_test_contents&gt;&gt;
  (dbg <span style="color: #8b2252;">"passed: hh-test~%"</span>))
(hh-test)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_test_contents"></pre>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Точки входа</h2>
<div class="outline-text-2" id="text-8">
<p>
Соберем шаблоны:
</p>

<div class="org-src-container">

<pre class="src src-closure-template-html" id="hh_tpl"><span style="color: #b22222;">// -*- mode: closure-template-html; fill-column: 140 -*-</span>
{<span style="color: #228b22; font-weight: bold;">namespace</span> <span style="color: #0000ff;">hhtpl</span>}

&lt;&lt;<span style="color: #0000ff;">hhtpl_contents</span>&gt;&gt;
</pre>
</div>

<p>
Скомпилируем шаблоны при подготовке модуля
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_prepare">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">special syntax for pattern-matching</span>
(ql:quickload '(<span style="color: #8b2252;">"fare-quasiquote-optima"</span> <span style="color: #8b2252;">"fare-quasiquote-readtable"</span>))
(named-readtables:in-readtable <span style="color: #483d8b;">:fare-quasiquote</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084; &#1096;&#1072;&#1073;&#1083;&#1086;&#1085;</span>
(closure-template:compile-template
 <span style="color: #483d8b;">:common-lisp-backend</span>
 (pathname
  (concatenate 'string *base-path* <span style="color: #8b2252;">"mod/hh/hh-tpl.htm"</span>)))
</pre>
</div>

<p>
Соберем контроллеры и все функции, которые контроллеры вызывают
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="hh_fn">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;run&gt;&gt;

&lt;&lt;_hh_fn_contents&gt;&gt;

&lt;&lt;_hh_parse&gt;&gt;

&lt;&lt;_hh_test&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Сборка</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> Фунциональные утилиты</h3>
<div class="outline-text-3" id="text-9-1">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;f_util_contents&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-9-1-1" class="outline-4">
<h4 id="sec-9-1-1"><span class="section-number-4">9.1.1</span> Point-free определения:</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define</span> (form* form)
  (<span style="color: #a020f0;">etypecase</span> form*
    (symbol (<span style="color: #a020f0;">etypecase</span> form
              <span style="color: #b22222;">;; </span><span style="color: #b22222;">alias for function or macro</span>
              (symbol `(<span style="color: #a020f0;">defmacro</span> ,form* (<span style="color: #228b22;">&amp;rest</span> args)
                         `(,',form ,@args)))
              <span style="color: #b22222;">;; </span><span style="color: #b22222;">alias for lambda</span>
              (cons   `(<span style="color: #a020f0;">defun</span> ,form* (<span style="color: #228b22;">&amp;rest</span> args)
                         (apply ,form args)))))
    (cons     <span style="color: #b22222;">;; </span><span style="color: #b22222;">scheme-like function definition</span>
     ` (<span style="color: #a020f0;">defun</span> ,(first form*) ,(rest form*)
         ,form))))
</pre>
</div>

<p>
Тут typecase используется до генерации кода - в зависимости от того символы или списки
связываются друг с другом генерируются различные определения. Можно определять
псевдонимы для функций и маросов, псевдоним будет макросом:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define head car)
(define tail cdr)
(define \\   lambda)
(define $    funcall)
</pre>
</div>

<p>
Можно определить функцию f2, которая является псевдонимом для лямбды, возвращённой
формой (f1 a1):
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define f2 (f1 a1))
(f2 a2) ~ (apply (f1 a1) a2)
</pre>
</div>

<p>
Простое определение функций в Scheme-стиле, более соответствующее представлению о
редукции форм:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (f1 a1) (f2 a2))
(f1 a1) ~ (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">f1</span> (a1) (f2 a2))
</pre>
</div>

<p>
Также, чтобы определять функции миксующую аргументы с другой функцией, можно ввести
такой макрос:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">define*</span> (form* form)
  `(<span style="color: #a020f0;">defun</span> ,(first form*) ,(rest form*)
     (,(first form) ,@(rest form) ,@(rest form*))))
</pre>
</div>

<p>
Пример:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define* (f1 a1) (f2 a2))
(f1 a1) ~ (f2 a2 a1)
</pre>
</div>

<p>
Либо использовать карринг.
</p>
</div>
</div>

<div id="outline-container-sec-9-1-2" class="outline-4">
<h4 id="sec-9-1-2"><span class="section-number-4">9.1.2</span> Flip, карринг, композиции:</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
далее f, g, &#x2026; обозначают функции,
      a, b, &#x2026; - их аргументы.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (self object) object)
(define (flip f)      (\\ (a b) ($ f b a)))
(define (curry f a)   (\\ (b)   ($ f a b)))
(define (curry* f g)  (\\ (a b) ($ f g a b)))
(define (compose f g) (\\ (a)   ($ f ($ g a))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-3" class="outline-4">
<h4 id="sec-9-1-3"><span class="section-number-4">9.1.3</span> Свёртки и "развёртки":</h4>
<div class="outline-text-4" id="text-9-1-3">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(define (foldl f a list)
    (<span style="color: #a020f0;">typecase</span> list
      (null a)
      (cons (foldl f ($ f a (head list)) (tail list)))))

(define (foldr f a list)
    (<span style="color: #a020f0;">typecase</span> list
      (null a)
      (cons ($ f (head list) (foldr f a (tail list))))))

(define (unfold f i p)
    (<span style="color: #a020f0;">if</span> ($ p i)
        (cons i '())
        (cons i (unfold f ($ f i) p))))

(define fold foldl)
(define my-reduce fold)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-4" class="outline-4">
<h4 id="sec-9-1-4"><span class="section-number-4">9.1.4</span> Отображения и фильтрации:</h4>
<div class="outline-text-4" id="text-9-1-4">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">map &amp; filter</span>
(define (my-map f list) (foldr (\\ (x y) (cons ($ f x) y)) '() list))
(define (filter p list) (foldr (\\ (x y) (<span style="color: #a020f0;">if</span> ($ p x) (cons x y) y)) '() list))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-5" class="outline-4">
<h4 id="sec-9-1-5"><span class="section-number-4">9.1.5</span> Функции для списков на основе карринга и свёрток:</h4>
<div class="outline-text-4" id="text-9-1-5">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for lists</span>
(define (my-list <span style="color: #228b22;">&amp;rest</span> objs)         objs)
(define (my-length list)             (fold (\\ (x y) (1+ x)) 0 list))
(define (my-reverse list)            (fold (flip 'cons) '() list))
(define (my-append list <span style="color: #228b22;">&amp;rest</span> lists) (fold (flip (curry* 'foldr 'cons)) list lists))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-6" class="outline-4">
<h4 id="sec-9-1-6"><span class="section-number-4">9.1.6</span> Функции для чисел:</h4>
<div class="outline-text-4" id="text-9-1-6">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for numbers</span>
(define zero?                    (curry '= 0))
(define positive?                (curry '&lt; 0))
(define negative?                (curry '&gt; 0))
(define (odd? number)            (= (mod number 2) 1))
(define (even? number)           (= (mod number 2) 0))
(define (my-max a <span style="color: #228b22;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #a020f0;">if</span> (&gt; y z) y z)) a numbers))
(define (my-min a <span style="color: #228b22;">&amp;rest</span> numbers) (fold (\\ (y z) (<span style="color: #a020f0;">if</span> (&lt; y z) y z)) a numbers))
(define (summa <span style="color: #228b22;">&amp;rest</span> numbers)    (fold '+ 0 numbers))
(define (product <span style="color: #228b22;">&amp;rest</span> numbers)  (fold '* 1 numbers))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-7" class="outline-4">
<h4 id="sec-9-1-7"><span class="section-number-4">9.1.7</span> И для булевых чисел:</h4>
<div class="outline-text-4" id="text-9-1-7">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">functions for booleans</span>
(define (my-and <span style="color: #228b22;">&amp;rest</span> list)   (fold 'and t list))
(define (my-or <span style="color: #228b22;">&amp;rest</span> list)    (fold 'or nil list))
(define (any? p <span style="color: #228b22;">&amp;rest</span> list)   (apply 'my-or (my-map p list)))
(define (every? p <span style="color: #228b22;">&amp;rest</span> list) (apply 'my-and (my-map p list)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-8" class="outline-4">
<h4 id="sec-9-1-8"><span class="section-number-4">9.1.8</span> Многие другие функции представляются свёртками, например:</h4>
<div class="outline-text-4" id="text-9-1-8">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">member &amp; assoc</span>
(<span style="color: #a020f0;">flet</span> ((helper (p op)
         (\\ (a next) (<span style="color: #a020f0;">if</span> (and (not a) ($ p ($ op next))) next a))))

  (define (my-member object list <span style="color: #228b22;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'self) nil list))

  (define (my-assoc object alist <span style="color: #228b22;">&amp;key</span> (test 'equal))
      (fold (helper (curry test object) 'car) nil alist)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-1-9" class="outline-4">
<h4 id="sec-9-1-9"><span class="section-number-4">9.1.9</span> Свёртки для деревьев:</h4>
<div class="outline-text-4" id="text-9-1-9">
<p>
Теперь, собственно, код для деревьев. Нужно заметить, что учитывая весь код для
"абстракций", получается существенно меньше, чем при реализации "в лоб" (как у Грэхама,
например).
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">for (1 . (2 . 3)) trees</span>

(define (my-append a b)
    (append (<span style="color: #a020f0;">if</span> (atom a) (list a) a)
            (<span style="color: #a020f0;">if</span> (atom b) (list b) b)))

(define (fold-tree f g tree)
    (<span style="color: #a020f0;">typecase</span> tree
      (atom ($ f tree))
      (cons ($ g (fold-tree f g (head tree))
               (fold-tree f g (tail tree))))))

(define* (summa/tree tree) (fold-tree 'self '+))
(define* (depth/tree tree) (fold-tree 'one 'max+1))
(define* (flatten tree)    (fold-tree 'self 'my-append))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> Другие утилиты</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">

<pre class="src src-lisp" id="f_util_contents">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defun my-range (n)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let ((i 0))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">#'(lambda ()</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">(if (&lt; i n) (incf i) nil))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(let ((f (my-range 3)))</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(list</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;;    </span><span style="color: #b22222;">(funcall f)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(range 3)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(defmacro do-closure ((i clos) &amp;body body)</span>
<span style="color: #b22222;">;;   </span><span style="color: #b22222;">(let ((c (gensym)))</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">`(let ((,c ,clos))</span>
<span style="color: #b22222;">;;        </span><span style="color: #b22222;">(loop for ,i = (funcall ,c)</span>
<span style="color: #b22222;">;;           </span><span style="color: #b22222;">while ,i do ,@body))))</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">(do-closure (i (my-range 100)) (print i))</span>


(<span style="color: #a020f0;">declaim</span> (<span style="color: #a020f0;">inline</span> zip))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">zip</span> (<span style="color: #228b22;">&amp;rest</span> args)
  <span style="color: #8b2252;">"</span>
<span style="color: #8b2252;">Zips the elements of @arg{args}.</span>
<span style="color: #8b2252;">Example:</span>
<span style="color: #8b2252;">@lisp</span>
<span style="color: #8b2252;">&gt; (zip '(2 3 4) '(a b c) '(j h c s))</span>
<span style="color: #8b2252;">=&gt; ((2 A J) (3 B H) (4 C C))</span>
<span style="color: #8b2252;">@end lisp</span>
<span style="color: #8b2252;">"</span>
  (apply #'map 'list #'list args))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">symstuff</span> (l)
  <span style="color: #8b2252;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html</span>
<span style="color: #8b2252;">Helper function to (build-symbol)"</span>
  `(concatenate 'string
                ,@(for (x <span style="color: #483d8b;">:in</span> l)
                       (<span style="color: #a020f0;">cond</span> ((stringp x)
                              `',x)
                             ((atom x)
                              `',(format nil <span style="color: #8b2252;">"~a"</span> x))
                             ((eq (car x) '<span style="color: #483d8b;">:&lt;</span>)
                              `(format nil <span style="color: #8b2252;">"~a"</span> ,(cadr x)))
                             ((eq (car x) '<span style="color: #483d8b;">:++</span>)
                              `(format nil <span style="color: #8b2252;">"~a"</span> (incf ,(cadr x))))
                             (t
                              `(format nil <span style="color: #8b2252;">"~a"</span> ,x))))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">build-symbol</span> (<span style="color: #228b22;">&amp;rest</span> l)
  <span style="color: #8b2252;">"From the Common Lisp Cookbook - http://cl-cookbook.sourceforge.net/macros.html"</span>
  (<span style="color: #a020f0;">let</span> ((p (find-if (<span style="color: #a020f0;">lambda</span> (x) (and (consp x) (eq (car x) '<span style="color: #483d8b;">:package</span>)))
                    l)))
    (<span style="color: #a020f0;">cond</span> (p
           (setq l (remove p l))))
    (<span style="color: #a020f0;">let</span> ((pkg (<span style="color: #a020f0;">cond</span> ((eq (cadr p) 'nil)
                      nil)
                     (t `(find-package ',(cadr p))))))
      (<span style="color: #a020f0;">cond</span> (p
             (<span style="color: #a020f0;">cond</span> (pkg
                    `(values (intern ,(symstuff l) ,pkg)))
                   (t
                    `(make-symbol ,(symstuff l)))))
            (t
             `(values (intern ,(symstuff l))))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">remove-nth</span> (n seq)
  <span style="color: #8b2252;">"Remove nth element from sequence"</span>
  (remove-if (constantly t) seq <span style="color: #483d8b;">:start</span> n <span style="color: #483d8b;">:count</span> 1))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-hash</span> (<span style="color: #228b22;">&amp;rest</span> keyvals)
  <span style="color: #8b2252;">"Create a hash table given keys and values"</span>
  (plist-hash-table keyvals))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">make-hash*</span> (<span style="color: #228b22;">&amp;rest</span> keyvals)
  <span style="color: #8b2252;">"Make a hash table given key/value pairs, allowing use of prior key/val pairs in late r definitions"</span>
  (<span style="color: #a020f0;">loop</span> while keyvals
     for k = (intern (symbol-name (pop keyvals)))
     for v = (pop keyvals)
     collect `(,k ,v) into letargs
     collect (make-keyword k) into objargs
     collect k into objargs
     finally (<span style="color: #a020f0;">return</span>
               `(<span style="color: #a020f0;">let*</span> (,@letargs)
                  (make-hash ,@objargs)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maphash2</span> (fn ht)
  <span style="color: #8b2252;">"Returns a hash-table with the results of the function of key &amp; value as values"</span>
  (<span style="color: #a020f0;">let</span> ((ht-out (make-hash-table
                 <span style="color: #483d8b;">:test</span> (hash-table-test ht)
                 <span style="color: #483d8b;">:size</span> (hash-table-size ht)
                 <span style="color: #483d8b;">:rehash-size</span> (hash-table-rehash-size ht)
                 <span style="color: #483d8b;">:rehash-threshold</span> (hash-table-rehash-threshold ht))))
    (maphash #'(<span style="color: #a020f0;">lambda</span> (k v)
                 (setf (gethash k ht-out) (funcall fn k v)))
             ht)
    ht-out))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maphash-values2</span> (fn ht)
  <span style="color: #8b2252;">"Returns a hash-table with the results of the function of value as values"</span>
  (<span style="color: #a020f0;">let</span> ((ht-out (make-hash-table)))
    (maphash #'(<span style="color: #a020f0;">lambda</span> (k v) (setf (gethash k ht-out) (funcall fn v))) ht)
    ht-out))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">swap</span> (pl1 pl2)
  <span style="color: #8b2252;">"Macro to swap two places"</span>
  (<span style="color: #a020f0;">let</span> ((temp1-name (gensym)) <span style="color: #b22222;">; </span><span style="color: #b22222;">don't clobber existing names</span>
        (temp2-name (gensym)))
    `(<span style="color: #a020f0;">let</span> ((,temp1-name ,pl1)
           (,temp2-name ,pl2))
       (setf ,pl1 ,temp2-name)
       (setf ,pl2 ,temp1-name))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">print-hash-key-or-val</span> (kv stream)
  (format stream (<span style="color: #a020f0;">typecase</span> kv
                   (keyword <span style="color: #8b2252;">" :~a"</span>)
                   (string <span style="color: #8b2252;">" \"~a\""</span>)
                   (symbol <span style="color: #8b2252;">" '~a"</span>)
                   (list <span style="color: #8b2252;">" '~a"</span>)
                   (t <span style="color: #8b2252;">" ~a"</span>)) kv))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">printhash</span> (h <span style="color: #228b22;">&amp;optional</span> (stream t))
  <span style="color: #8b2252;">"Pretty print a hash table as :KEY VAL on separate lines"</span>
  (format stream <span style="color: #8b2252;">"#&lt;HASH-TABLE~{~a~a~^~&amp;~}&gt;"</span>
          (<span style="color: #a020f0;">loop</span> for k being the hash-keys in h using (hash-value v)
             collect (print-hash-key-or-val k nil)
             collect (print-hash-key-or-val v nil))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">lethash</span> (keys h <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Let form binding hash table entries to let variables names"</span>
  (<span style="color: #a020f0;">let</span> ((ht (gensym)))
    `(<span style="color: #a020f0;">let</span> ((,ht ,h))
       (<span style="color: #a020f0;">let</span> ,(<span style="color: #a020f0;">loop</span> for key in keys
                collect `(,key (gethash ,(make-keyword key) ,ht)))
         ,@body))))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">with-keys</span> (keys h <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Make keys of hash table available to body for use &amp; changable via setf"</span>
  (<span style="color: #a020f0;">let</span> ((ht (gensym)))
    (<span style="color: #a020f0;">loop</span> for key in keys
       for newbody = (subst `(gethash ,(make-keyword key) ,ht) key body)
       then (subst `(gethash ,(make-keyword key) ,ht) key newbody)
       finally (<span style="color: #a020f0;">return</span> `(<span style="color: #a020f0;">let</span> ((,ht ,h))
                          ,@newbody)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">linear-interpolation</span> (ys xs x)
  <span style="color: #8b2252;">"Linear interpolation: calculate y(x) at x given table of ys and xs. Also returns ind ex of lookup table interval. Works from first x to less than last x."</span>
  (<span style="color: #a020f0;">let*</span> ((i (position x xs <span style="color: #483d8b;">:test</span> #'&gt;= <span style="color: #483d8b;">:from-end</span> t))
         (x0 (elt xs i))
         (x1 (elt xs (1+ i)))
         (y0 (elt ys i))
         (y1 (elt ys (1+ i))))
    (+ y0 (* (- y1 y0) (- x x0) (/ (- x1 x0))))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">maptree</span> (f tree)
  <span style="color: #8b2252;">"Map a function on the leaves of a tree"</span>
  (<span style="color: #a020f0;">cond</span>
    ((null tree) nil)
    ((atom tree) (funcall f tree))
    (t (cons (maptree f (car tree))
             (maptree f (cdr tree))))))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">diff</span> ((l list))
  <span style="color: #8b2252;">"Return list of the 1st differences of given list: l(1)-l(0),...,l(n)-l(n-1)"</span>
    (<span style="color: #a020f0;">loop</span> for i below (1- (length l))
       for li in l
       collect (- (elt l (1+ i)) li)))

(<span style="color: #a020f0;">defmethod</span> <span style="color: #0000ff;">diff</span> ((v vector))
  <span style="color: #8b2252;">"Return vector of the 1st differences of given vector: v(1)-v(0),...,v(n)-v(n-1)"</span>
  (<span style="color: #a020f0;">let*</span> ((n (length v))
         (v2 (make-array (1- n))))
    (<span style="color: #a020f0;">dotimes</span> (i (1- n))
      (setf (aref v2 i) (- (aref v (1+ i)) (aref v i))))
    v2))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slot-ref</span> (obj slots)
  <span style="color: #8b2252;">"Reference nested objects by a list of successive slot names. For example, (slot-ref  o 'foo 'bar 'baz) should return (slot-value (slot-value (slot-value o 'foo) 'bar) 'baz) "</span>
  (<span style="color: #a020f0;">cond</span>
    ((atom slots) (slot-value obj slots))
    ((null (cdr slots)) (slot-value obj (car slots)))
    (t (slot-ref (slot-value obj (first slots)) (rest slots)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">slot-ref-set</span> (obj slots val)
  <span style="color: #8b2252;">"Set nested object slot reference to new value"</span>
  (<span style="color: #a020f0;">cond</span>
    ((atom slots) (setf (slot-value obj slots) val))
    ((null (cdr slots)) (setf (slot-value obj (car slots)) val))
    (t (slot-ref-set (slot-value obj (first slots)) (rest slots) val))))

(<span style="color: #a020f0;">defsetf</span> <span style="color: #0000ff;">slot-ref</span> slot-ref-set)

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">bind-nested-slots</span> (forms obj <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"For each form of (VAR SLOT1 SLOT2 ...) bind VAR to (NESTED-SLOT OBJ SLOT1 SLOT2 ...) "</span>
  `(<span style="color: #a020f0;">let</span> ,(<span style="color: #a020f0;">loop</span> for form in forms
            collect `(,(first form) (slot-ref ,obj ',(rest form))))
     ,@body))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">defpfun</span> (name args pargs <span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Define pandoric function given name, arguments, pandoric arguments,</span>
<span style="color: #8b2252;">&amp; body forms."</span>
  `(setf (symbol-function ',name)
         (plambda ,args ,pargs
                  ,@body)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> Утилиты</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">

<pre class="src src-lisp" id="utility_file">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*user-agent*</span> <span style="color: #8b2252;">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:33.0) Gecko/20100101 Firefox/33.0"</span>)

(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*cookies*</span>
  (list <span style="color: #8b2252;">"portal_tid=1291969547067-10909"</span>
        <span style="color: #8b2252;">"__utma=189530924.115785001.1291969547.1297497611.1297512149.377"</span>
        <span style="color: #8b2252;">"__utmc=3521885"</span>))

(setf *drakma-default-external-format* <span style="color: #483d8b;">:utf-8</span>)

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">get-headers</span> (referer)
  `(
    (<span style="color: #8b2252;">"Accept"</span> . <span style="color: #8b2252;">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>)
    (<span style="color: #8b2252;">"Accept-Language"</span> . <span style="color: #8b2252;">"ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3"</span>)
    (<span style="color: #8b2252;">"Accept-Charset"</span> . <span style="color: #8b2252;">"utf-8"</span>)
    (<span style="color: #8b2252;">"Referer"</span> . ,referer)
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">("Cookie" . ,(format nil "~{~a; ~}" *cookies*))</span>
    (<span style="color: #8b2252;">"Cookie"</span> . <span style="color: #8b2252;">"ad20c=2; ad17c=2; __utma=48706362.2093251633.1396569814.1413985658.1413990550.145; __utmz=48706362.1413926450.142.18.utmcsr=vk.com|utmccn=(referral)|utmcmd=referral|utmcct=/im; email=avenger-f%40yandex.ru; password=30e3465569cc7433b34d42baeadff18f; PHPSESSID=ms1rrsgjqvm3lhdl5af1aekvv0; __utmc=48706362; __utmb=48706362.5.10.1413990550"</span>)
    ))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">web</span> (to ot)
  (<span style="color: #a020f0;">let</span> ((x-to (append '(format nil) to))
        (x-ot (append '(format nil) ot)))
    `(<span style="color: #a020f0;">let</span> ((r (sb-ext:octets-to-string
               (drakma:http-request ,x-to
                                    <span style="color: #483d8b;">:user-agent</span> *user-agent*
                                    <span style="color: #483d8b;">:additional-headers</span> (get-headers ,x-ot)
                                    <span style="color: #483d8b;">:force-binary</span> t)
               <span style="color: #483d8b;">:external-format</span> <span style="color: #483d8b;">:utf-8</span>)))
       r)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">fnd</span> (var pattern)
  `(<span style="color: #a020f0;">multiple-value-bind</span> (all matches)
       (ppcre:scan-to-strings ,pattern ,var)
     (<span style="color: #a020f0;">let</span> ((str (format nil <span style="color: #8b2252;">"~a"</span> matches)))
       (subseq str 2 (- (length str) 1)))))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">merge-plists</span> (<span style="color: #228b22;">&amp;rest</span> plists)
  <span style="color: #8b2252;">"Merge all the given plists into a new plist. The new plist has all</span>
<span style="color: #8b2252;">the keys from each plist, with values of keys in later lists</span>
<span style="color: #8b2252;">overriding the values of the same keys in earlier plists.</span>
<span style="color: #8b2252;">No particular order of key/value pairs is guaranteed.</span>
<span style="color: #8b2252;">E.g.:</span>
<span style="color: #8b2252;">&gt; (merge-plists '(:a 1 :b 2) '(:a 3 :c 4) '(:d 5))</span>
<span style="color: #ff0000; font-weight: bold;">(</span><span style="color: #8b2252;">:D 5 :C 4 :A 3 :B 2)"</span>
(<span style="color: #a020f0;">let</span> ((result (copy-list (first plists))))
  (<span style="color: #a020f0;">dolist</span> (plist (rest plists))
    (<span style="color: #a020f0;">do*</span> ((prop (first plist) (first plist))
          (value (second plist) (second plist))
          (oldpl plist plist)
          (plist plist (cddr plist)))
         ((not oldpl))
      (setf (getf result prop) value)))
  result))

(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">contains</span> (string pattern)
  (<span style="color: #a020f0;">if</span> (search pattern string)
      t))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">eval-always</span>

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">eval-always</span> (<span style="color: #228b22;">&amp;body</span> body)
  <span style="color: #8b2252;">"Wrap &lt;_:arg body /&gt; in &lt;_:fun eval-when /&gt; with all keys \(compile, load and execute) mentioned"</span>
  `(<span style="color: #a020f0;">eval-when</span> (<span style="color: #483d8b;">:compile-toplevel</span> <span style="color: #483d8b;">:load-toplevel</span> <span style="color: #483d8b;">:execute</span>)
     ,@body))

<span style="color: #b22222;">;; </span><span style="color: #b22222;">#` syntax</span>

(eval-always
  (<span style="color: #a020f0;">defun</span> |#`-reader| (stream char arg)
    <span style="color: #8b2252;">"Literal syntax for zero/one/two argument lambdas.</span>
<span style="color: #8b2252;">Use @ as the function's argument, % as the second.</span>
<span style="color: #8b2252;">Examples:</span>
<span style="color: #8b2252;">CL-USER&gt; #`(+ 2 @)</span>
<span style="color: #8b2252;">\(lambda (&amp;optional x y)</span>
<span style="color: #8b2252;">   (+ 2 x))</span>
<span style="color: #8b2252;">CL-USER&gt;  #`((1+ @) (print @))</span>
<span style="color: #8b2252;">\(lambda (&amp;optional x y)</span>
<span style="color: #8b2252;">   (1+ x)</span>
<span style="color: #8b2252;">   (print x))</span>
<span style="color: #8b2252;">CL-USER&gt; #`(+ 1 2)</span>
<span style="color: #8b2252;">\(lambda (&amp;optional x y)</span>
<span style="color: #8b2252;">   (+ 1 2))</span>
<span style="color: #8b2252;">CL-USER&gt;  #`(+ @ %)</span>
<span style="color: #8b2252;">\(lambda (&amp;optional x y)</span>
<span style="color: #8b2252;">   (+ x y))</span>
<span style="color: #8b2252;">"</span>
    (<span style="color: #a020f0;">declare</span> (ignore char arg))
    (<span style="color: #a020f0;">let</span> ((sexp (read stream t nil t))
          (x (gensym <span style="color: #8b2252;">"X"</span>))
          (y (gensym <span style="color: #8b2252;">"Y"</span>)))
      `(<span style="color: #a020f0;">lambda</span> (<span style="color: #228b22;">&amp;optional</span> ,x ,y)
         (<span style="color: #a020f0;">declare</span> (ignorable ,x)
                  (ignorable ,y))
         ,@(subst y '%
                  (subst x '@
                         (<span style="color: #a020f0;">if</span> (listp (car sexp))
                             sexp
                             (list sexp)))))))
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">set #`</span>
  (set-dispatch-macro-character #\# #\` #'|#`-reader|))


<span style="color: #b22222;">;; </span><span style="color: #b22222;">anaphoric</span>

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">if-it</span> (test then <span style="color: #228b22;">&amp;optional</span> else)
   <span style="color: #8b2252;">"Like IF. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">let</span> ((it ,test))
      (<span style="color: #a020f0;">if</span> it ,then ,else))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">when-it</span> (test <span style="color: #228b22;">&amp;body</span> body)
   <span style="color: #8b2252;">"Like WHEN. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">let</span> ((it ,test))
      (<span style="color: #a020f0;">when</span> it
        ,@body))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">and-it</span> (<span style="color: #228b22;">&amp;rest</span> args)
   <span style="color: #8b2252;">"Like AND. IT is bound to the value of the previous AND form."</span>
   (<span style="color: #a020f0;">cond</span> ((null args) t)
         ((null (cdr args)) (car args))
         (t `(<span style="color: #a020f0;">when-it</span> ,(car args) (and-it ,@(cdr args)))))))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">dowhile-it</span> (test <span style="color: #228b22;">&amp;body</span> body)
   <span style="color: #8b2252;">"Like DOWHILE. IT is bound to TEST."</span>
   `(<span style="color: #a020f0;">do</span> ((it ,test ,test))
        ((not it))
      ,@body)))

(eval-always
 (<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">cond-it</span> (<span style="color: #228b22;">&amp;body</span> body)
   <span style="color: #8b2252;">"Like COND. IT is bound to the passed COND test."</span>
   `(<span style="color: #a020f0;">let</span> (it)
      (<span style="color: #a020f0;">cond</span>
        ,@(mapcar #``((setf it ,(car @)) ,(cadr @))
                  <span style="color: #b22222;">;; </span><span style="color: #b22222;">uses the fact, that SETF returns the value set</span>
                  body)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">maybe</span>


(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">maybecall</span> (val <span style="color: #228b22;">&amp;rest</span> funs)
  `(and-it ,val
           ,@(mapcar (<span style="color: #a020f0;">lambda</span> (fun)
                       `(funcall ,fun it))
                     funs)))

(<span style="color: #a020f0;">defmacro</span> <span style="color: #0000ff;">maybe</span> (form)
  <span style="color: #8b2252;">"Return a value, returned by a &lt;_:arg form /&gt; or nil, if &lt;_:class error /&gt; is signalled"</span>
  `(<span style="color: #a020f0;">restart-case</span>
       (<span style="color: #a020f0;">handler-bind</span> ((<span style="color: #ff0000; font-weight: bold;">error</span> #'(<span style="color: #a020f0;">lambda</span> (c)
                                 (<span style="color: #a020f0;">declare</span> (ignore condition))
                                 (invoke-restart 'skip))))
         ,form)
     (skip () nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4"><span class="section-number-3">9.4</span> Глобальные определения</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">

<pre class="src src-lisp" id="globals">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

<span style="color: #b22222;">;; </span><span style="color: #b22222;">clear db</span>
(drop '(<span style="color: #8b2252;">"profile"</span> <span style="color: #8b2252;">"vacancy"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5"><span class="section-number-3">9.5</span> Сущности и автоматы</h3>
<div class="outline-text-3" id="text-9-5">
<p>
Соберем все сущности и автоматы
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="entity_and_automates">(<span style="color: #a020f0;">in-package</span> #<span style="color: #483d8b;">:moto</span>)

&lt;&lt;asm_profile()&gt;&gt;

&lt;&lt;asm_vacancy()&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6"><span class="section-number-3">9.6</span> Поисковые профили</h3>
<div class="outline-text-3" id="text-9-6">
<div class="org-src-container">

<pre class="src src-emacs-lisp" id="asm_profile">(gen-entity <span style="color: #8b2252;">"profile"</span> <span style="color: #8b2252;">"&#1087;&#1086;&#1080;&#1089;&#1082;&#1086;&#1074;&#1099;&#1077; &#1087;&#1088;&#1086;&#1092;&#1080;&#1083;&#1080;"</span> flds)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-7" class="outline-3">
<h3 id="sec-9-7"><span class="section-number-3">9.7</span> Вакансии</h3>
<div class="outline-text-3" id="text-9-7">
<div class="org-src-container">

<pre class="src src-emacs-lisp" id="asm_vacancy">(gen-automat <span style="color: #8b2252;">"vacancy"</span> <span style="color: #8b2252;">"&#1074;&#1072;&#1082;&#1072;&#1085;&#1089;&#1080;&#1080;"</span> flds states)
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: rigidus</p>
<p class="date">Created: 2015-01-18 Вс. 01:01</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode )</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
